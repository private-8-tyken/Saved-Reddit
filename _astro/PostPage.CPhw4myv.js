import{j as e}from"./jsx-runtime.D_zvdyIk.js";import{r as o}from"./index.RH_Wq4ov.js";import{l as C,P as A,s as E}from"./Skeleton.Bcj8ELcl.js";function b({c:t,depth:s=0}){const[i,l]=o.useState(!0);return e.jsxs("div",{style:{marginLeft:s?12:0,borderLeft:s?"1px solid var(--border)":"none",paddingLeft:s?10:0,marginTop:8},children:[e.jsxs("div",{className:"meta",children:[t.author||"[deleted]"," • ",t.score??0," pts",e.jsx("button",{className:"button",style:{marginLeft:8,padding:"4px 8px"},onClick:()=>l(n=>!n),children:i?"Collapse":"Expand"})]}),i&&e.jsx("div",{style:{whiteSpace:"pre-wrap",marginTop:6},children:t.body}),i&&Array.isArray(t.replies)&&t.replies.map(n=>e.jsx(b,{c:n,depth:s+1},n.id))]})}function T({comments:t}){return!t||!t.length?e.jsx("div",{className:"meta",children:"No comments."}):e.jsx("div",{children:t.map(s=>e.jsx(b,{c:s},s.id))})}const v="/Saved-Reddit/",y=v.endsWith("/")?v:v+"/";function w({rootMargin:t="300px"}={}){const s=o.useRef(null),[i,l]=o.useState(!1);return o.useEffect(()=>{const n=s.current;if(!n)return;const a=new IntersectionObserver(([u])=>l(u.isIntersecting),{rootMargin:t,threshold:.01});return a.observe(n),()=>a.disconnect()},[t]),[s,i]}function N({src:t,alt:s="",srcSet:i,sizes:l,posterLike:n}){const[a,u]=w(),[m,f]=o.useState(!1),x=(u?t:void 0)||n||t;return e.jsx("div",{ref:a,style:{borderRadius:10,overflow:"hidden"},children:e.jsx("img",{src:x,alt:s,loading:"lazy",decoding:"async",srcSet:u?i:void 0,sizes:l||"(max-width: 768px) 100vw, 900px",onLoad:()=>f(!0),style:{width:"100%",height:"auto",display:"block",filter:m?"none":"blur(12px)",transition:"filter 180ms ease"}})})}function P({src:t,poster:s,mediaType:i}){const[l,n]=w(),[a,u]=o.useState(null),m=i==="gif";return o.useEffect(()=>{n&&!a&&u(t)},[n,a,t]),e.jsx("div",{ref:l,style:{borderRadius:10,overflow:"hidden"},children:e.jsx("video",{autoPlay:!0,playsInline:!0,preload:"metadata",poster:s||"",style:{width:"100%",height:"auto",display:"block"},src:a||void 0,onPlay:f=>{const p=f.currentTarget;new IntersectionObserver(([j])=>{j.isIntersecting||p.pause()},{threshold:.01}).observe(p)},muted:m,controls:!m})})}function _({items:t=[],alt:s=""}){const[i,l]=o.useState(0);if(!t.length)return null;const n=t[i]||t[0];return e.jsxs("div",{children:[e.jsx(N,{src:n,alt:s}),t.length>1&&e.jsxs("div",{className:"row",style:{gap:8,justifyContent:"center",marginTop:8},children:[e.jsx("button",{className:"button",onClick:()=>l(a=>Math.max(0,a-1)),children:"Prev"}),e.jsxs("div",{className:"meta",children:[i+1,"/",t.length]}),e.jsx("button",{className:"button",onClick:()=>l(a=>Math.min(t.length-1,a+1)),children:"Next"})]})]})}function F(t){if(!t)return null;const s=(t.media_type||"").toLowerCase(),i=Array.isArray(t.media_urls)?t.media_urls.filter(Boolean):[],l=Number.isFinite(t.gallery_count)?t.gallery_count:i.length,n=i[0],a=u=>/\.mp4($|\?)/i.test(u)||/\.webm($|\?)/i.test(u);return i.length?s==="gallery"||l>1?{type:"gallery",items:i}:s==="video"||s==="gif"||a(n)?{type:"video",src:n,poster:t.media_preview||""}:{type:"image",src:n}:null}function B({id:t}){const[s,i]=o.useState(null),[l,n]=o.useState(null),[a,u]=o.useState(null),[m,f]=o.useState(new Set),p=m.has(t),x=()=>{const r=new Set(m);p?r.delete(t):r.add(t),f(r),E(r)};if(o.useEffect(()=>{let r=!0;const h=new AbortController;return u(null),i(null),fetch(`${y}data/posts/${t}.json`,{signal:h.signal}).then(d=>{if(!d.ok)throw new Error(`HTTP ${d.status}`);return d.json()}).then(d=>{r&&i(d)}).catch(d=>{r&&d.name!=="AbortError"&&u(d.message||"Failed to load")}),()=>{r=!1,h.abort()}},[t]),o.useEffect(()=>{let r=!0;const h=new AbortController;return n(null),fetch(`${y}data/indexes/posts-manifest.json`,{signal:h.signal}).then(d=>d.json()).then(d=>{if(!r)return;const S=Array.isArray(d)?d.find(k=>k.id===t):null;n(S||null)}).catch(()=>{r&&n(null)}),()=>{r=!1,h.abort()}},[t]),o.useEffect(()=>{f(C())},[]),a)return e.jsx("div",{className:"container",children:e.jsxs("div",{className:"card",children:[e.jsx("h3",{children:"Post not found"}),e.jsx("div",{className:"meta",children:a}),e.jsx("div",{className:"row",style:{marginTop:8},children:e.jsx("button",{className:"button",onClick:()=>history.length>1?window.history.back():window.location.href=y,children:"← Back"})})]})});if(!s&&!a)return e.jsx(A,{});const j=[s.link_flair_text||s.flair||"",s.subreddit?`r/${s.subreddit}`:"",s.author?`u/${s.author}`:""].filter(Boolean).join(" • ");let c=F(l);if(!c){const r=s?.media;r?.video?.url?c={type:"video",src:r.video.url,poster:r.video.poster||""}:Array.isArray(r?.items)&&r.items.length>1?c={type:"gallery",items:r.items.map(h=>h.url)}:Array.isArray(r?.items)&&r.items.length===1?c={type:"image",src:r.items[0].url}:r?.image?.url&&(c={type:"image",src:r.image.url})}let g=null;return c&&(c.type==="video"?g=e.jsx(P,{src:c.src,poster:c.poster,mediaType:l.media_type}):c.type==="gallery"?g=e.jsx(_,{items:c.items,alt:s.title||""}):c.type==="image"&&(g=e.jsx(N,{src:c.src,alt:s.title||""}))),e.jsxs("div",{className:"container",children:[e.jsxs("div",{className:"row",style:{marginTop:12,marginBottom:8},children:[e.jsx("button",{className:"button",onClick:()=>history.length>1?window.history.back():window.location.href=y,children:"← Back"}),e.jsx("button",{className:"button",onClick:x,children:p?"⭐ Unstar":"☆ Star"}),(l?.permalink||s.permalink)&&e.jsx("a",{className:"button",href:l?.permalink||s.permalink,target:"_blank",rel:"noopener noreferrer",children:"Open on Reddit ↗"})]}),e.jsxs("article",{className:"card",children:[e.jsx("h2",{style:{marginTop:0},children:s.title}),e.jsx("div",{className:"meta",children:j}),e.jsx("hr",{className:"sep"}),g,s.selftext&&e.jsxs(e.Fragment,{children:[e.jsx("hr",{className:"sep"}),e.jsx("div",{style:{whiteSpace:"pre-wrap"},children:s.selftext})]})]}),e.jsx("h3",{style:{marginTop:16},children:"Comments"}),e.jsx("article",{className:"card",children:e.jsx(T,{comments:s.comments||[]})})]})}export{B as default};
