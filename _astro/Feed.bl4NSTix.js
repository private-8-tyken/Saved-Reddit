import{j as e}from"./jsx-runtime.D_zvdyIk.js";import{r as l}from"./index.RH_Wq4ov.js";import{s as D,S as G,l as H}from"./storage.BqWfYwIo.js";function J(t="",o=200){if(!t)return"";const i=String(t).replace(/[*_~`>#-]+/g," ").replace(/\[(.*?)\]\((.*?)\)/g,"$1").replace(/\s+/g," ").trim();if(i.length<=o)return i;const s=i.slice(0,o),r=s.lastIndexOf(" ");return(r>60?s.slice(0,r):s).trim()+"…"}function Y(t=""){try{return new URL(t).hostname.replace(/^www\./,"")}catch{return""}}function K({post:t,favs:o,setFavs:i,base:s,searchTerm:r=""}){const S=o.has(t.id),A=()=>{const c=new Set(o);S?c.delete(t.id):c.add(t.id),i(c),D(c)},P="viewedPosts",z=typeof window<"u",d=(()=>{if(!z)return new Set;try{return new Set(JSON.parse(localStorage.getItem(P)||"[]"))}catch{return new Set}})(),F=d.has(t.id);function L(){if(z)try{const c=Array.from(d.add(t.id));localStorage.setItem(P,JSON.stringify(c))}catch{}}const h=t.created_utc?new Date(t.created_utc*1e3):null,b=h?h.toISOString():"",q=h?h.toLocaleDateString(void 0,{month:"short",day:"numeric",year:"numeric"}):"",j=t.media_type||null,_=t.media_preview||null,n=Array.isArray(t.media_urls)?t.media_urls:t.media_url_compact?Array.isArray(t.media_url_compact)?t.media_url_compact:[t.media_url_compact]:[],a=t.gallery_count??(n.length>1?n.length:null),f=(j==="video"||j==="gif")&&n.length>0&&/\.mp4(\?|#|$)/i.test(n[0]),x=j==="gallery"&&(a?a>0:n.length>1),y=j==="image"&&n.length>=1&&!f,p=f||x||y,[u,v]=l.useState(!1),[O,R]=l.useState(0);l.useEffect(()=>{u||R(0)},[u]);function T(c,w){const C=(w||"").trim();if(!C)return c;try{const k=new RegExp(`(${C.replace(/[.*?^${}()|[\\]\\\\]/g,"\\$&")})`,"ig");return String(c).split(k).map((U,B)=>k.test(U)?e.jsx("mark",{children:U},B):e.jsx("span",{children:U},B))}catch{return c}}const E=J(t.selftext_preview||(t.media_type==="link"&&t.url?`Link: ${Y(t.url)}`:"")||"",240),M=!!_||f,g=`pc-grid ${M?"has-thumb":"no-thumb"}`,m=l.useRef(null),N=l.useMemo(()=>{if(!u||!p)return null;if(f){const c=n[0],w=j==="gif";return e.jsx("div",{className:"pc-expand",children:e.jsx("div",{className:"pc-video-wrap",children:e.jsx("video",{ref:m,src:c,poster:_||void 0,controls:!w,autoPlay:!0,loop:!0,muted:w,playsInline:!0,preload:"metadata",className:"pc-media-el"})})})}if(x){const c=n[O]||n[0],w=a||n.length,C=()=>R(I=>(I-1+w)%w),k=()=>R(I=>(I+1)%w);return e.jsx("div",{className:"pc-expand",children:e.jsxs("div",{className:"pc-gallery",children:[e.jsx("img",{src:c,alt:"",loading:"eager",decoding:"async",className:"pc-media-el"}),e.jsxs("div",{className:"pc-gallery-bar",children:[e.jsx("button",{type:"button",className:"pc-btn",onClick:C,"aria-label":"Previous",children:"‹"}),e.jsxs("span",{className:"pc-count",children:[O+1," / ",w]}),e.jsx("button",{type:"button",className:"pc-btn",onClick:k,"aria-label":"Next",children:"›"})]})]})})}return y?e.jsx("div",{className:"pc-expand",children:e.jsx("img",{src:n[0],alt:"",loading:"eager",decoding:"async",className:"pc-media-el"})}):null},[u,p,f,n,j,_,x,y,O,a]);return e.jsx("article",{className:`card post-card ${F?"is-viewed":""}`,children:e.jsxs("div",{className:g,children:[M?e.jsx("aside",{className:"pc-left",children:e.jsx("a",{href:`${s}post/${encodeURIComponent(t.id)}`,onClick:()=>{try{const c="feed:scroll:"+location.search;sessionStorage.setItem(c,String(window.scrollY||0))}catch{}L()},children:_?e.jsx("img",{src:_,alt:"",loading:"lazy",decoding:"async",className:"pc-thumb"}):e.jsx("div",{className:"pc-thumb pc-thumb--video",children:e.jsx("span",{className:"pc-play",children:"▶"})})})}):null,e.jsxs("div",{className:"pc-right",children:[e.jsxs("div",{className:"topline",children:[t.subreddit&&e.jsxs("a",{className:"subreddit",href:`https://www.reddit.com/r/${encodeURIComponent(t.subreddit)}`,target:"_blank",rel:"noreferrer noopener",children:["r/",t.subreddit]}),e.jsx("span",{className:"dot",children:"•"}),t.author&&e.jsxs("span",{className:"by",children:["Posted by"," ",e.jsxs("a",{className:"author",href:`https://www.reddit.com/user/${encodeURIComponent(t.author)}`,target:"_blank",rel:"noreferrer noopener",children:["u/",t.author]})]}),q&&e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"dot",children:"•"}),e.jsx("time",{dateTime:b,title:h?.toLocaleString?.()||"",children:q})]}),t.saved_index!=null&&e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"dot",children:"•"}),e.jsxs("span",{className:"saved meta",children:["Saved #",t.saved_index]})]})]}),e.jsxs("h3",{className:"title",children:[e.jsx("a",{className:"title-link",href:`${s}post/${encodeURIComponent(t.id)}`,onClick:()=>{try{const c="feed:scroll:"+location.search;sessionStorage.setItem(c,String(window.scrollY||0))}catch{}L()},children:T(t.title,r)}),t.flair?e.jsx("span",{className:"flair",children:t.flair}):null,j?e.jsxs("span",{className:"pill",children:[j,x?` (${a||n.length})`:""]}):null]}),E&&e.jsx("p",{className:"preview",children:T(E,r)}),e.jsxs("div",{className:"bottomline",children:[t.score!=null&&e.jsxs("span",{className:"score",children:["▲ ",t.score]}),e.jsx("span",{className:"dot",children:"•"}),t.num_comments!=null&&e.jsxs("span",{className:"comments",children:["💬 ",t.num_comments]}),p&&e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"dot",children:"•"}),e.jsx("button",{className:"action expand",type:"button",onClick:()=>v(c=>!c),"aria-expanded":u?"true":"false",title:u?"Collapse media":"Expand media",children:u?"ᐱ Collapse":"⤢ Expand"})]}),e.jsx("span",{className:"spacer"}),t.permalink&&e.jsx("a",{className:"action view",href:t.permalink,target:"_blank",rel:"noopener noreferrer",onClick:L,children:"View on Reddit"}),e.jsx("button",{className:`star ${S?"is-on":""}`,"aria-label":S?"Remove from favorites":"Add to favorites","aria-pressed":S?"true":"false",onClick:A,children:S?"⭐ Star":"☆ Star"})]}),N]})]})})}const $=1e15;function V(t,o){const i=t.saved_index??$,s=o.saved_index??$;return i!==s?i-s:(o.created_utc??0)-(t.created_utc??0)}function W(t,o="asc"){const i=o==="desc"?-1:1;switch(t){case"saved":return(s,r)=>i*V(s,r);case"created":return(s,r)=>i*((s.created_utc??0)-(r.created_utc??0));case"score":return(s,r)=>i*((s.score??-$)-(r.score??-$));case"comments":return(s,r)=>i*((s.num_comments??-$)-(r.num_comments??-$));case"title":return(s,r)=>i*String(s.title).localeCompare(String(r.title));case"subreddit":return(s,r)=>i*String(s.subreddit).localeCompare(String(r.subreddit));case"author":return(s,r)=>i*String(s.author).localeCompare(String(r.author));case"domain":return(s,r)=>i*String(s.link_domain||"").localeCompare(String(r.link_domain||""));case"flair":return(s,r)=>i*String(s.flair||"").localeCompare(String(r.flair||""));default:return(s,r)=>i*V(s,r)}}const Q="/Saved-Reddit/";function X(){return typeof window>"u"?"":window.location.search||""}function Z(){const[t,o]=l.useState(()=>new URLSearchParams(X()));l.useEffect(()=>{if(typeof window>"u")return;const s=()=>o(new URLSearchParams(window.location.search));return window.addEventListener("popstate",s),window.addEventListener("urlchange",s),()=>{window.removeEventListener("popstate",s),window.removeEventListener("urlchange",s)}},[]);const i=l.useCallback(s=>{if(typeof window>"u")return;const r=new URL(window.location.href);r.search=s.toString(),window.history.pushState({},"",r),window.dispatchEvent(new Event("urlchange")),o(new URLSearchParams(r.search))},[]);return[t,i]}function se({favoritesOnly:t=!1}){const[o,i]=l.useState(null),[s,r]=l.useState(null),[S,A]=l.useState(new Set),[P,z]=l.useState(30),[d,F]=Z();l.useEffect(()=>{const n=()=>A(H());if(n(),typeof window<"u")return window.addEventListener("favorites:changed",n),()=>window.removeEventListener("favorites:changed",n)},[]),l.useEffect(()=>{let n=!0;return r(null),fetch(`${Q}data/indexes/posts-manifest.json`).then(a=>{if(!a.ok)throw new Error(`HTTP ${a.status}`);return a.json()}).then(a=>{n&&i(a)}).catch(a=>{n&&r(a.message||"Failed to load")}),()=>{n=!1}},[]),l.useEffect(()=>{if(typeof document>"u")return;const n=document.getElementById("searchInput"),a=document.getElementById("sortSelect");if(!n||!a)return;const f=d.get("sort")||"saved";d.get("dir"),a.value=f,n.value=d.get("q")||"";const x=p=>{const u=p.target.value,v=new URLSearchParams({...Object.fromEntries(d),q:u});F(v)},y=p=>{const u=p.target.value,v=new URLSearchParams({...Object.fromEntries(d),sort:u});v.get("dir")||v.set("dir",u==="created"?"desc":"asc"),F(v)};return n.addEventListener("input",x),a.addEventListener("change",y),()=>{n.removeEventListener("input",x),a.removeEventListener("change",y)}},[d,F]),l.useEffect(()=>{z(30)},[d.toString()]);const L=l.useMemo(()=>{if(!o)return[];let n=o;t&&(n=n.filter(g=>S.has(g.id)));const a=(d.get("q")||"").toLowerCase().trim();a&&(n=n.filter(g=>g.title&&g.title.toLowerCase().includes(a)||g.selftext_preview&&g.selftext_preview.toLowerCase().includes(a)));const f=g=>(d.get(g)||"").split(",").map(m=>m&&decodeURIComponent(m)).filter(Boolean),x=new Set(f("subs")),y=new Set(f("authors")),p=new Set(f("flairs")),u=new Set(f("media")),v=new Set(f("domains"));if(x.size||y.size||p.size||u.size||v.size){const g=(d.get("mode")||"or").toLowerCase();n=n.filter(m=>{const N=x.size&&m.subreddit&&x.has(String(m.subreddit)),c=y.size&&m.author&&y.has(String(m.author)),w=p.size&&m.flair&&p.has(String(m.flair)),C=u.size&&m.media_type&&u.has(String(m.media_type)),k=v.size&&m.link_domain&&v.has(String(m.link_domain)),I=!!(N||c||w||C||k),U=[x.size?N:!0,y.size?c:!0,p.size?w:!0,u.size?C:!0,v.size?k:!0].every(Boolean);return g==="and"?U:I})}const R=d.get("sort")||"saved",T=d.get("dir")||(R==="created"?"desc":"asc");let E=[...n].sort(W(R,T));if(d.get("favfirst")==="1"){const g=E.filter(N=>S.has(N.id)),m=E.filter(N=>!S.has(N.id));E=[...g,...m]}return E},[o,d,t,S]),h=l.useRef(null),b=l.useRef(null),q=l.useCallback(n=>{if(b.current&&h.current)try{h.current.unobserve(b.current)}catch{}if(b.current=n,n&&h.current)try{h.current.observe(n)}catch{}},[]);if(l.useEffect(()=>{if(!(typeof window>"u")){if(h.current=new IntersectionObserver(n=>{n.some(a=>a.isIntersecting)&&z(a=>a+30)},{root:null,rootMargin:"600px 0px 600px 0px",threshold:.01}),b.current)try{h.current.observe(b.current)}catch{}return()=>{try{h.current&&h.current.disconnect()}catch{}h.current=null}}},[]),s)return e.jsx("div",{className:"container",children:e.jsxs("div",{className:"card",children:[e.jsx("h3",{children:"Couldn’t load posts"}),e.jsx("div",{className:"meta",children:s})]})});if(!o)return e.jsx("div",{className:"container","aria-busy":"true",children:Array.from({length:6}).map((n,a)=>e.jsx(G,{},a))});const j=L.slice(0,P),_=P<L.length;return e.jsxs("div",{className:"container",children:[j.length===0&&e.jsxs("div",{className:"card",children:[e.jsx("h3",{children:"No results"}),e.jsx("div",{className:"meta",children:"Try clearing filters or changing your search."})]}),j.map(n=>e.jsx(K,{post:n,favs:S,setFavs:A,base:Q,searchTerm:(d.get("q")||"").trim()},n.id)),_&&e.jsx("div",{ref:q,className:"sentinel"})]})}export{se as default};
