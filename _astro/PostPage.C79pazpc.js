import{j as e}from"./jsx-runtime.D_zvdyIk.js";import{r as l}from"./index.RH_Wq4ov.js";import{l as C,P as A,s as E}from"./Skeleton.CRWqq5in.js";function w({comments:t,initialLimit:s=25,childLimit:n=8,depth:o=0}){const[r,i]=l.useState(()=>Math.min(s,Array.isArray(t)?t.length:0)),a=Array.isArray(t)?t:[],f=a.slice(0,r),d=a.length-r,x=l.useCallback(()=>{i(c=>Math.min(c+s,a.length))},[s,a.length]);return a.length?e.jsxs("div",{className:`ct ${o===0?"ct-root":""}`,children:[f.map(c=>e.jsx(R,{node:c,depth:o,childLimit:n},c.id)),d>0&&e.jsxs("button",{className:"ct-more",onClick:x,children:["Show more comments (",d,")"]})]}):o===0?e.jsx("div",{className:"ct-empty",children:"No comments"}):null}function R({node:t,depth:s,childLimit:n}){const{id:o,author:r=null,body:i="",score:a=null,replies:f=[]}=t||{},[d,x]=l.useState(!1),c=Array.isArray(f)?f.length:0,[m,u]=l.useState(()=>Math.min(n,c)),y=c-m,h=l.useCallback(()=>x(v=>!v),[]),g=l.useCallback(()=>{u(v=>Math.min(v+n,c))},[n,c]);l.useEffect(()=>{u(v=>Math.min(Math.max(n,v),c))},[c,n]);const p=r??"[deleted]",j=typeof a=="number"?`${a} point${a===1?"":"s"}`:null;return e.jsxs("div",{className:`ct-node depth-${s}`,children:[e.jsx("div",{className:"ct-line"}),e.jsxs("div",{className:"ct-card",children:[e.jsxs("div",{className:"ct-meta",children:[e.jsx("button",{className:"ct-collapse","aria-expanded":!d,"aria-label":d?"Expand":"Collapse",onClick:h,title:d?"Expand":"Collapse",children:d?"➕":"➖"}),e.jsx("span",{className:"ct-author",children:p}),j&&e.jsxs("span",{className:"ct-score",children:[" · ",j]})]}),i&&!d&&e.jsx("div",{className:"ct-body",children:i}),!d&&c>0&&e.jsxs("div",{className:"ct-children",children:[e.jsx(w,{comments:f.slice(0,m),initialLimit:m,childLimit:n,depth:s+1}),y>0&&e.jsxs("button",{className:"ct-more",onClick:g,children:["Show more replies (",y,")"]})]})]})]})}const b="/Saved-Reddit/";function k({rootMargin:t="300px",threshold:s=.01}={}){const n=l.useRef(null),[o,r]=l.useState(!1);return l.useEffect(()=>{const i=n.current;if(!i||typeof IntersectionObserver>"u")return;const a=new IntersectionObserver(([f])=>r(f.isIntersecting),{rootMargin:t,threshold:s});return a.observe(i),()=>a.disconnect()},[t,s]),[n,o]}function N({src:t,alt:s="",srcSet:n,sizes:o,posterLike:r}){const[i,a]=k(),[f,d]=l.useState(!1),c=(a?t:void 0)||r||t;return e.jsx("div",{ref:i,style:{borderRadius:10,overflow:"hidden"},children:e.jsx("img",{src:c,alt:s,loading:"lazy",decoding:"async",srcSet:a?n:void 0,sizes:o||"(max-width: 768px) 100vw, 900px",onLoad:()=>d(!0),style:{width:"100%",height:"auto",display:"block",filter:f?"none":"blur(12px)",transition:"filter 180ms ease"}})})}function S({src:t,poster:s,mutedByType:n}){const[o,r]=k(),[i,a]=l.useState(null),f=l.useRef(null);return l.useEffect(()=>{r&&!i&&a(t)},[r,i,t]),l.useEffect(()=>{const d=f.current;if(d)if(r)d.play().catch(()=>{});else try{d.pause(),d.currentTime=0}catch{}},[r]),l.useEffect(()=>()=>{try{f.current&&f.current.pause()}catch{}},[]),e.jsx("div",{ref:o,style:{borderRadius:10,overflow:"hidden"},children:e.jsx("video",{ref:f,autoPlay:!0,playsInline:!0,preload:"auto",poster:s||"",style:{width:"100%",height:"auto",display:"block"},src:i||void 0,muted:!!n,controls:!n,loop:!0})})}function _(t){if(!t)return null;const s=Array.isArray(t.media_items)?t.media_items:[];if(!s.length)return null;if(s.length>1)return{type:"gallery",items:s.map(o=>({kind:o.kind,url:o.url,poster:o.poster||null}))};const n=s[0];return n.kind==="video"||n.kind==="redgiphy"?{type:"video",src:n.url,poster:n.poster||t.media_preview||"",mutedByType:!1}:n.kind==="gif"?{type:"image",src:n.url}:{type:"image",src:n.url}}function T(t,s){if(!t)return null;const n=Array.isArray(t.media_urls)?t.media_urls.filter(Boolean):Array.isArray(t.media_url_compact)?t.media_url_compact:t.media_url_compact?[t.media_url_compact]:[];if(!n.length)return null;const o=(t.media_type||"").toLowerCase(),r=a=>/\.mp4($|\?)/i.test(a)||/\.webm($|\?)/i.test(a);if(o==="gallery"||n.length>1)return{type:"gallery",items:n.map(a=>({kind:r(a)?"video":/\.gif(\?|#|$)/i.test(a)?"gif":"image",url:a}))};const i=n[0];return o==="video"||r(i)?{type:"video",src:i,poster:t.media_preview||"",mutedByType:!1}:o==="gif"||/\.gif(\?|#|$)/i.test(i)?{type:"image",src:i}:{type:"image",src:i}}function P({onSwipeLeft:t,onSwipeRight:s,threshold:n=24,maxAngle:o=36}={}){const r=l.useRef(null),[i,a]=l.useState(0),[f,d]=l.useState(!1),x=u=>{if(!(u.button!==void 0&&u.button!==0)){r.current={x:u.clientX,y:u.clientY,id:u.pointerId},d(!0);try{u.currentTarget.setPointerCapture?.(u.pointerId)}catch{}}},c=u=>{if(!r.current)return;const y=u.clientX-r.current.x;u.clientY-r.current.y,a(y*.95)},m=u=>{if(!r.current)return;const y=u.clientX-r.current.x,h=u.clientY-r.current.y,g=Math.abs(y),p=Math.abs(h);Math.atan2(p,g)*180/Math.PI<=o&&g>=n&&(y<0?t?.():s?.()),d(!1),a(0),r.current=null};return{bind:{onPointerDown:x,onPointerMove:c,onPointerUp:m,onPointerCancel:m,style:{touchAction:"pan-y",transform:`translate3d(${i}px,0,0)`,transition:f?"none":"transform 160ms ease",willChange:"transform"}}}}function $({items:t=[],title:s=""}){const[n,o]=l.useState(0),r=t.length,i=t[n],a=c=>o(m=>(m+c+r)%r),f=()=>a(-1),d=()=>a(1);l.useEffect(()=>{const c=m=>{m.key==="ArrowLeft"?(m.preventDefault(),f()):m.key==="ArrowRight"&&(m.preventDefault(),d())};return window.addEventListener("keydown",c),()=>window.removeEventListener("keydown",c)},[r]),l.useEffect(()=>{const c=t[(n+1)%r];if(c&&c.kind==="image"){const m=new Image;m.src=c.url}},[n,r,t]);const x=P({onSwipeLeft:d,onSwipeRight:f,threshold:24,maxAngle:36});return e.jsxs("div",{children:[r>1&&e.jsxs("div",{className:"row",style:{gap:8,justifyContent:"center",marginTop:8},children:[e.jsx("button",{className:"button",onClick:f,"aria-label":"Previous (←)",children:"‹ Prev"}),e.jsxs("div",{className:"meta",children:[n+1,"/",r]}),e.jsx("button",{className:"button",onClick:d,"aria-label":"Next (→)",children:"Next ›"})]}),e.jsx("div",{className:"pc-swipe",...x.bind,children:i.kind==="video"||i.kind==="redgiphy"?e.jsx(S,{src:i.url,poster:i.poster||"",mutedByType:!1}):e.jsx(N,{src:i.url,alt:s})})]})}function V({id:t}){const[s,n]=l.useState(null),[o,r]=l.useState(null),[i,a]=l.useState(null),[f,d]=l.useState(new Set),x=f.has(t),c=()=>{const h=new Set(f);x?h.delete(t):h.add(t),d(h),E(h)};if(l.useEffect(()=>{let h=!0;const g=new AbortController;return a(null),n(null),fetch(`${b}data/posts/${t}.json`,{signal:g.signal}).then(p=>{if(!p.ok)throw new Error(`HTTP ${p.status}`);return p.json()}).then(p=>{h&&n(p)}).catch(p=>{h&&p.name!=="AbortError"&&a(p.message||"Failed to load")}),()=>{h=!1,g.abort()}},[t]),l.useEffect(()=>{let h=!0;const g=new AbortController;return r(null),fetch(`${b}data/indexes/posts-manifest.json`,{signal:g.signal}).then(p=>p.json()).then(p=>{if(!h)return;const j=Array.isArray(p)?p.find(v=>v.id===t):null;r(j||null)}).catch(()=>{h&&r(null)}),()=>{h=!1,g.abort()}},[t]),l.useEffect(()=>{d(C())},[]),i)return e.jsx("div",{className:"container",children:e.jsxs("div",{className:"card",children:[e.jsx("h3",{children:"Post not found"}),e.jsx("div",{className:"meta",children:i}),e.jsx("div",{className:"row",style:{marginTop:8},children:e.jsx("button",{className:"button",onClick:()=>history.length>1?window.history.back():window.location.href=b,children:"← Back"})})]})});if(!s&&!i)return e.jsx(A,{});const m=[s.link_flair_text||s.flair||"",s.subreddit?`r/${s.subreddit}`:"",s.author?`u/${s.author}`:""].filter(Boolean).join(" • "),u=_(o)||T(o)||null;let y=null;return u&&(u.type==="video"?y=e.jsx(S,{src:u.src,poster:u.poster,mutedByType:u.mutedByType}):u.type==="gallery"?y=e.jsx($,{items:u.items,title:s.title||""}):u.type==="image"&&(y=e.jsx(N,{src:u.src,alt:s.title||""}))),e.jsxs("div",{className:"container",children:[e.jsxs("div",{className:"row",style:{marginTop:12,marginBottom:8},children:[e.jsx("button",{className:"button",onClick:()=>history.length>1?window.history.back():window.location.href=b,children:"← Back"}),e.jsx("button",{className:"button",onClick:c,children:x?"⭐ Unstar":"☆ Star"}),(o?.permalink||s.permalink)&&e.jsx("a",{className:"button",href:o?.permalink||s.permalink,target:"_blank",rel:"noopener noreferrer",children:"Open on Reddit ↗"})]}),e.jsxs("article",{className:"card",children:[e.jsx("h2",{style:{marginTop:0},children:s.title}),e.jsx("div",{className:"meta",children:m}),e.jsx("hr",{className:"sep"}),y,s.selftext&&e.jsxs(e.Fragment,{children:[e.jsx("hr",{className:"sep"}),e.jsx("div",{style:{whiteSpace:"pre-wrap"},children:s.selftext})]})]}),e.jsx("h3",{style:{marginTop:16},children:"Comments"}),e.jsx("article",{className:"card",children:e.jsx(w,{comments:s.comments||[]})})]})}export{V as default};
