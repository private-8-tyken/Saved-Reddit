import{j as e}from"./jsx-runtime.D_zvdyIk.js";import{r as i}from"./index.RH_Wq4ov.js";import{s as G,S as H,l as J}from"./Skeleton.Bcj8ELcl.js";function W(t="",o=200){if(!t)return"";const a=String(t).replace(/[*_~`>#-]+/g," ").replace(/\[(.*?)\]\((.*?)\)/g,"$1").replace(/\s+/g," ").trim();if(a.length<=o)return a;const s=a.slice(0,o),r=s.lastIndexOf(" ");return(r>60?s.slice(0,r):s).trim()+"â€¦"}function Y(t=""){try{return new URL(t).hostname.replace(/^www\./,"")}catch{return""}}function K(t={root:null,rootMargin:"300px",threshold:.01}){const o=i.useRef(null),[a,s]=i.useState(!1);return i.useEffect(()=>{if(!o.current||typeof IntersectionObserver>"u")return;const r=new IntersectionObserver(([p])=>s(p.isIntersecting),t);return r.observe(o.current),()=>r.disconnect()},[]),[o,a]}function X({src:t}){const[o,a]=K(),s=i.useRef(null);return i.useEffect(()=>{const r=s.current;r&&(a?r.play().catch(()=>{}):r.pause())},[a]),e.jsxs("div",{ref:o,className:"pc-thumb pc-thumb--video",children:[e.jsx("video",{ref:s,src:t,muted:!0,loop:!0,playsInline:!0,preload:"none",className:"pc-thumb-video"}),e.jsx("span",{className:"pc-play",children:"â–¶"})]})}function Z({post:t,favs:o,setFavs:a,base:s,searchTerm:r=""}){const p=o.has(t.id),A=()=>{const l=new Set(o);p?l.delete(t.id):l.add(t.id),a(l),G(l)},P="viewedPosts",z=typeof window<"u",d=(()=>{if(!z)return new Set;try{return new Set(JSON.parse(localStorage.getItem(P)||"[]"))}catch{return new Set}})(),F=d.has(t.id);function R(){if(z)try{const l=Array.from(d.add(t.id));localStorage.setItem(P,JSON.stringify(l))}catch{}}const h=t.created_utc?new Date(t.created_utc*1e3):null,N=h?h.toISOString():"",V=h?h.toLocaleDateString(void 0,{month:"short",day:"numeric",year:"numeric"}):"",j=t.media_type||null,_=t.media_preview||null,n=Array.isArray(t.media_urls)?t.media_urls:t.media_url_compact?Array.isArray(t.media_url_compact)?t.media_url_compact:[t.media_url_compact]:[],c=t.gallery_count??(n.length>1?n.length:null),f=(j==="video"||j==="gif")&&n.length>0&&/\.mp4(\?|#|$)/i.test(n[0]),v=j==="gallery"&&(c?c>0:n.length>1),y=j==="image"&&n.length>=1&&!f,x=f||v||y,[u,w]=i.useState(!1),[O,k]=i.useState(0);i.useEffect(()=>{u||k(0)},[u]);function q(l,S){const C=(S||"").trim();if(!C)return l;try{const I=new RegExp(`(${C.replace(/[.*?^${}()|[\\]\\\\]/g,"\\$&")})`,"ig");return String(l).split(I).map((U,B)=>I.test(U)?e.jsx("mark",{children:U},B):e.jsx("span",{children:U},B))}catch{return l}}const E=W(t.selftext_preview||(t.media_type==="link"&&t.url?`Link: ${Y(t.url)}`:"")||"",240),T=!!_||f,g=`pc-grid ${T?"has-thumb":"no-thumb"}`,m=i.useRef(null),b=i.useMemo(()=>{if(!u||!x)return null;if(f){const l=n[0],S=j==="gif";return e.jsx("div",{className:"pc-expand",children:e.jsx("div",{className:"pc-video-wrap",children:e.jsx("video",{ref:m,src:l,poster:_||void 0,controls:!S,autoPlay:!0,loop:!0,muted:S,playsInline:!0,preload:"metadata",className:"pc-media-el"})})})}if(v){const l=n[O]||n[0],S=c||n.length,C=()=>k(L=>(L-1+S)%S),I=()=>k(L=>(L+1)%S);return e.jsx("div",{className:"pc-expand",children:e.jsxs("div",{className:"pc-gallery",children:[e.jsx("img",{src:l,alt:"",loading:"eager",decoding:"async",className:"pc-media-el"}),e.jsxs("div",{className:"pc-gallery-bar",children:[e.jsx("button",{type:"button",className:"pc-btn",onClick:C,"aria-label":"Previous",children:"â€¹"}),e.jsxs("span",{className:"pc-count",children:[O+1," / ",S]}),e.jsx("button",{type:"button",className:"pc-btn",onClick:I,"aria-label":"Next",children:"â€º"})]})]})})}return y?e.jsx("div",{className:"pc-expand",children:e.jsx("img",{src:n[0],alt:"",loading:"eager",decoding:"async",className:"pc-media-el"})}):null},[u,x,f,n,j,_,v,y,O,c]);return e.jsx("article",{className:`card post-card ${F?"is-viewed":""}`,children:e.jsxs("div",{className:g,children:[T?e.jsx("aside",{className:"pc-left",children:e.jsx("a",{href:`${s}post/${encodeURIComponent(t.id)}`,onClick:()=>{try{const l="feed:scroll:"+location.search;sessionStorage.setItem(l,String(window.scrollY||0))}catch{}R()},children:_?e.jsx("img",{src:_,alt:"",loading:"lazy",decoding:"async",className:"pc-thumb"}):f?e.jsx(X,{src:n[0]}):e.jsx("div",{className:"pc-thumb pc-thumb--video",children:e.jsx("span",{className:"pc-play",children:"â–¶"})})})}):null,e.jsxs("div",{className:"pc-right",children:[e.jsxs("div",{className:"topline",children:[t.subreddit&&e.jsxs("a",{className:"subreddit",href:`https://www.reddit.com/r/${encodeURIComponent(t.subreddit)}`,target:"_blank",rel:"noreferrer noopener",children:["r/",t.subreddit]}),e.jsx("span",{className:"dot",children:"â€¢"}),t.author&&e.jsxs("span",{className:"by",children:["Posted by"," ",e.jsxs("a",{className:"author",href:`https://www.reddit.com/user/${encodeURIComponent(t.author)}`,target:"_blank",rel:"noreferrer noopener",children:["u/",t.author]})]}),V&&e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"dot",children:"â€¢"}),e.jsx("time",{dateTime:N,title:h?.toLocaleString?.()||"",children:V})]}),t.saved_index!=null&&e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"dot",children:"â€¢"}),e.jsxs("span",{className:"saved meta",children:["Saved #",t.saved_index]})]})]}),e.jsxs("h3",{className:"title",children:[e.jsx("a",{className:"title-link",href:`${s}post/${encodeURIComponent(t.id)}`,onClick:()=>{try{const l="feed:scroll:"+location.search;sessionStorage.setItem(l,String(window.scrollY||0))}catch{}R()},children:q(t.title,r)}),t.flair?e.jsx("span",{className:"flair",children:t.flair}):null,j?e.jsxs("span",{className:"pill",children:[j,v?` (${c||n.length})`:""]}):null]}),E&&e.jsx("p",{className:"preview",children:q(E,r)}),e.jsxs("div",{className:"bottomline",children:[t.score!=null&&e.jsxs("span",{className:"score",children:["â–² ",t.score]}),e.jsx("span",{className:"dot",children:"â€¢"}),t.num_comments!=null&&e.jsxs("span",{className:"comments",children:["ðŸ’¬ ",t.num_comments]}),x&&e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"dot",children:"â€¢"}),e.jsx("button",{className:"action expand",type:"button",onClick:()=>w(l=>!l),"aria-expanded":u?"true":"false",title:u?"Collapse media":"Expand media",children:u?"á± Collapse":"â¤¢ Expand"})]}),e.jsx("span",{className:"spacer"}),t.permalink&&e.jsx("a",{className:"action view",href:t.permalink,target:"_blank",rel:"noopener noreferrer",onClick:R,children:"View on Reddit"}),e.jsx("button",{className:`star ${p?"is-on":""}`,"aria-label":p?"Remove from favorites":"Add to favorites","aria-pressed":p?"true":"false",onClick:A,children:p?"â­ Star":"â˜† Star"})]}),b]})]})})}const $=1e15;function Q(t,o){const a=t.saved_index??$,s=o.saved_index??$;return a!==s?a-s:(o.created_utc??0)-(t.created_utc??0)}function ee(t,o="asc"){const a=o==="desc"?-1:1;switch(t){case"saved":return(s,r)=>a*Q(s,r);case"created":return(s,r)=>a*((s.created_utc??0)-(r.created_utc??0));case"score":return(s,r)=>a*((s.score??-$)-(r.score??-$));case"comments":return(s,r)=>a*((s.num_comments??-$)-(r.num_comments??-$));case"title":return(s,r)=>a*String(s.title).localeCompare(String(r.title));case"subreddit":return(s,r)=>a*String(s.subreddit).localeCompare(String(r.subreddit));case"author":return(s,r)=>a*String(s.author).localeCompare(String(r.author));case"domain":return(s,r)=>a*String(s.link_domain||"").localeCompare(String(r.link_domain||""));case"flair":return(s,r)=>a*String(s.flair||"").localeCompare(String(r.flair||""));default:return(s,r)=>a*Q(s,r)}}const M="/Saved-Reddit/",D=M.endsWith("/")?M:M+"/";function te(){return typeof window>"u"?"":window.location.search||""}function ne(){const[t,o]=i.useState(()=>new URLSearchParams(te()));i.useEffect(()=>{if(typeof window>"u")return;const s=()=>o(new URLSearchParams(window.location.search));return window.addEventListener("popstate",s),window.addEventListener("urlchange",s),()=>{window.removeEventListener("popstate",s),window.removeEventListener("urlchange",s)}},[]);const a=i.useCallback(s=>{if(typeof window>"u")return;const r=new URL(window.location.href);r.search=s.toString(),window.history.pushState({},"",r),window.dispatchEvent(new Event("urlchange")),o(new URLSearchParams(r.search))},[]);return[t,a]}function ce({favoritesOnly:t=!1}){const[o,a]=i.useState(null),[s,r]=i.useState(null),[p,A]=i.useState(new Set),[P,z]=i.useState(30),[d,F]=ne();i.useEffect(()=>{const n=()=>A(J());if(n(),typeof window<"u")return window.addEventListener("favorites:changed",n),()=>window.removeEventListener("favorites:changed",n)},[]),i.useEffect(()=>{let n=!0;return r(null),fetch(`${D}data/indexes/posts-manifest.json`).then(c=>{if(!c.ok)throw new Error(`HTTP ${c.status}`);return c.json()}).then(c=>{n&&a(c)}).catch(c=>{n&&r(c.message||"Failed to load")}),()=>{n=!1}},[]),i.useEffect(()=>{if(typeof document>"u")return;const n=document.getElementById("searchInput"),c=document.getElementById("sortSelect");if(!n||!c)return;const f=d.get("sort")||"saved";d.get("dir"),c.value=f,n.value=d.get("q")||"";const v=x=>{const u=x.target.value,w=new URLSearchParams({...Object.fromEntries(d),q:u});F(w)},y=x=>{const u=x.target.value,w=new URLSearchParams({...Object.fromEntries(d),sort:u});w.get("dir")||w.set("dir",u==="created"?"desc":"asc"),F(w)};return n.addEventListener("input",v),c.addEventListener("change",y),()=>{n.removeEventListener("input",v),c.removeEventListener("change",y)}},[d,F]),i.useEffect(()=>{z(30)},[d.toString()]);const R=i.useMemo(()=>{if(!o)return[];let n=o;t&&(n=n.filter(g=>p.has(g.id)));const c=(d.get("q")||"").toLowerCase().trim();c&&(n=n.filter(g=>g.title&&g.title.toLowerCase().includes(c)||g.selftext_preview&&g.selftext_preview.toLowerCase().includes(c)));const f=g=>(d.get(g)||"").split(",").map(m=>m&&decodeURIComponent(m)).filter(Boolean),v=new Set(f("subs")),y=new Set(f("authors")),x=new Set(f("flairs")),u=new Set(f("media")),w=new Set(f("domains"));if(v.size||y.size||x.size||u.size||w.size){const g=(d.get("mode")||"or").toLowerCase();n=n.filter(m=>{const b=v.size&&m.subreddit&&v.has(String(m.subreddit)),l=y.size&&m.author&&y.has(String(m.author)),S=x.size&&m.flair&&x.has(String(m.flair)),C=u.size&&m.media_type&&u.has(String(m.media_type)),I=w.size&&m.link_domain&&w.has(String(m.link_domain)),L=!!(b||l||S||C||I),U=[v.size?b:!0,y.size?l:!0,x.size?S:!0,u.size?C:!0,w.size?I:!0].every(Boolean);return g==="and"?U:L})}const k=d.get("sort")||"saved",q=d.get("dir")||(k==="created"?"desc":"asc");let E=[...n].sort(ee(k,q));if(d.get("favfirst")==="1"){const g=E.filter(b=>p.has(b.id)),m=E.filter(b=>!p.has(b.id));E=[...g,...m]}return E},[o,d,t,p]),h=i.useRef(null),N=i.useRef(null),V=i.useCallback(n=>{if(N.current&&h.current)try{h.current.unobserve(N.current)}catch{}if(N.current=n,n&&h.current)try{h.current.observe(n)}catch{}},[]);if(i.useEffect(()=>{if(!(typeof window>"u")){if(h.current=new IntersectionObserver(n=>{n.some(c=>c.isIntersecting)&&z(c=>c+30)},{root:null,rootMargin:"600px 0px 600px 0px",threshold:.01}),N.current)try{h.current.observe(N.current)}catch{}return()=>{try{h.current&&h.current.disconnect()}catch{}h.current=null}}},[]),s)return e.jsx("div",{className:"container",children:e.jsxs("div",{className:"card",children:[e.jsx("h3",{children:"Couldnâ€™t load posts"}),e.jsx("div",{className:"meta",children:s})]})});if(!o)return e.jsx("div",{className:"container","aria-busy":"true",children:Array.from({length:6}).map((n,c)=>e.jsx(H,{},c))});const j=R.slice(0,P),_=P<R.length;return e.jsxs("div",{className:"container",children:[j.length===0&&e.jsxs("div",{className:"card",children:[e.jsx("h3",{children:"No results"}),e.jsx("div",{className:"meta",children:"Try clearing filters or changing your search."})]}),j.map(n=>e.jsx(Z,{post:n,favs:p,setFavs:A,base:D,searchTerm:(d.get("q")||"").trim()},n.id)),_&&e.jsx("div",{ref:V,className:"sentinel"})]})}export{ce as default};
