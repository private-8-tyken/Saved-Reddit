import{j as t}from"./jsx-runtime.D_zvdyIk.js";import{r as l}from"./index.RH_Wq4ov.js";import{s as Q,S as T,l as V}from"./Skeleton.Bcj8ELcl.js";function H(e="",c=200){if(!e)return"";const i=String(e).replace(/[*_~`>#-]+/g," ").replace(/\[(.*?)\]\((.*?)\)/g,"$1").replace(/\s+/g," ").trim();if(i.length<=c)return i;const n=i.slice(0,c),a=n.lastIndexOf(" ");return(a>60?n.slice(0,a):n).trim()+"…"}function J(e=""){try{return new URL(e).hostname.replace(/^www\./,"")}catch{return""}}function K({post:e,favs:c,setFavs:i,base:n,searchTerm:a=""}){const w=c.has(e.id),b=()=>{const r=new Set(c);w?r.delete(e.id):r.add(e.id),i(r),Q(r)},N="viewedPosts",_=typeof window<"u",o=(()=>{if(!_)return new Set;try{return new Set(JSON.parse(localStorage.getItem(N)||"[]"))}catch{return new Set}})(),E=o.has(e.id);function k(){if(_)try{const r=Array.from(o.add(e.id));localStorage.setItem(N,JSON.stringify(r))}catch{}}const d=e.created_utc?new Date(e.created_utc*1e3):null,p=d?d.toISOString():"",C=d?d.toLocaleDateString(void 0,{month:"short",day:"numeric",year:"numeric"}):"",L=e.selftext_preview||e.selftext||e.media_type==="link"&&(e.url?`Link: ${J(e.url)}`:"")||"",R=H(L,200);function s(r,g){const v=(g||"").trim();if(!v)return r;try{const S=new RegExp(`(${v.replace(/[.*?^${}()|[\\]\\\\]/g,"\\$&")})`,"ig");return String(r).split(S).map((m,f)=>S.test(m)?t.jsx("mark",{children:m},f):t.jsx("span",{children:m},f))}catch{return r}}return t.jsxs("article",{className:`card post-card ${E?"is-viewed":""}`,style:{marginBottom:12},children:[t.jsxs("div",{className:"topline",children:[e.subreddit&&t.jsx("a",{className:"subreddit",href:`https://www.reddit.com/r/${encodeURIComponent(e.subreddit)}`,target:"_blank",rel:"noreferrer noopener",children:s(`r/${e.subreddit}`,a)}),t.jsx("span",{className:"dot",children:"•"}),e.author&&t.jsxs("span",{className:"by",children:["Posted by"," ",t.jsx("a",{className:"author",href:`https://www.reddit.com/user/${encodeURIComponent(e.author)}`,target:"_blank",rel:"noreferrer noopener",children:s(`u/${e.author}`,a)})]}),C&&t.jsxs(t.Fragment,{children:[t.jsx("span",{className:"dot",children:"•"}),t.jsx("time",{dateTime:p,title:d?.toLocaleString?.()||"",children:C})]}),e.saved_index!=null&&t.jsxs(t.Fragment,{children:[t.jsx("span",{className:"dot",children:"•"}),t.jsxs("span",{className:"saved meta",children:["Saved #",e.saved_index]})]})]}),e.media_preview?t.jsx("img",{src:e.media_preview,alt:"",loading:"lazy",decoding:"async",fetchpriority:"low",style:{width:"100%",borderRadius:10,display:"block"}}):null,t.jsxs("h3",{className:"title",style:{margin:"10px 2px"},children:[t.jsx("a",{className:"title-link",href:`${n}post/${encodeURIComponent(e.id)}`,onClick:()=>{try{const r="feed:scroll:"+location.search;sessionStorage.setItem(r,String(window.scrollY||0))}catch{}k()},children:s(e.title,a)}),e.flair?t.jsx("span",{className:"flair",children:e.flair}):null,e.media_type?t.jsx("span",{className:"pill",children:e.media_type}):null]}),R&&t.jsx("p",{className:"preview",children:s(R,a)}),t.jsxs("div",{className:"bottomline",style:{marginTop:8},children:[e.score!=null&&t.jsxs("span",{className:"score",children:["▲ ",e.score]}),t.jsx("span",{className:"dot",children:"•"}),e.num_comments!=null&&t.jsxs("span",{className:"comments",children:["💬 ",e.num_comments]}),t.jsx("span",{className:"spacer"}),e.permalink&&t.jsx("a",{className:"action view",href:e.permalink,target:"_blank",rel:"noopener noreferrer",onClick:k,children:"View on Reddit"}),t.jsx("span",{className:"star",role:"button","aria-label":w?"Remove from favorites":"Add to favorites","aria-pressed":w?"true":"false",tabIndex:0,title:w?"Click to unfavorite":"Click to favorite",onClick:b,onKeyDown:r=>(r.key==="Enter"||r.key===" ")&&(r.preventDefault(),b()),children:w?"⭐ Star":"☆ Star"})]})]})}const j=1e15;function A(e,c){const i=e.saved_index??j,n=c.saved_index??j;return i!==n?i-n:(c.created_utc??0)-(e.created_utc??0)}function W(e,c="asc"){const i=c==="desc"?-1:1;switch(e){case"saved":return(n,a)=>i*A(n,a);case"created":return(n,a)=>i*((n.created_utc??0)-(a.created_utc??0));case"score":return(n,a)=>i*((n.score??-j)-(a.score??-j));case"comments":return(n,a)=>i*((n.num_comments??-j)-(a.num_comments??-j));case"title":return(n,a)=>i*String(n.title).localeCompare(String(a.title));case"subreddit":return(n,a)=>i*String(n.subreddit).localeCompare(String(a.subreddit));case"author":return(n,a)=>i*String(n.author).localeCompare(String(a.author));case"domain":return(n,a)=>i*String(n.link_domain||"").localeCompare(String(a.link_domain||""));case"flair":return(n,a)=>i*String(n.flair||"").localeCompare(String(a.flair||""));default:return(n,a)=>i*A(n,a)}}const z="/Saved-Reddit/",B=z.endsWith("/")?z:z+"/";function Y(){return typeof window>"u"?"":window.location.search||""}function G(){const[e,c]=l.useState(()=>new URLSearchParams(Y()));l.useEffect(()=>{if(typeof window>"u")return;const n=()=>c(new URLSearchParams(window.location.search));return window.addEventListener("popstate",n),window.addEventListener("urlchange",n),()=>{window.removeEventListener("popstate",n),window.removeEventListener("urlchange",n)}},[]);const i=l.useCallback(n=>{if(typeof window>"u")return;const a=new URL(window.location.href);a.search=n.toString(),window.history.pushState({},"",a),window.dispatchEvent(new Event("urlchange")),c(new URLSearchParams(a.search))},[]);return[e,i]}function ne({favoritesOnly:e=!1}){const[c,i]=l.useState(null),[n,a]=l.useState(null),[w,b]=l.useState(new Set),[N,_]=l.useState(30),[o,E]=G();l.useEffect(()=>{const s=()=>b(V());if(s(),typeof window<"u")return window.addEventListener("favorites:changed",s),()=>window.removeEventListener("favorites:changed",s)},[]),l.useEffect(()=>{let s=!0;return a(null),fetch(`${B}data/indexes/posts-manifest.json`).then(r=>{if(!r.ok)throw new Error(`HTTP ${r.status}`);return r.json()}).then(r=>{s&&i(r)}).catch(r=>{s&&a(r.message||"Failed to load")}),()=>{s=!1}},[]),l.useEffect(()=>{if(typeof document>"u")return;const s=document.getElementById("searchInput"),r=document.getElementById("sortSelect");if(!s||!r)return;const g=o.get("sort")||"saved";o.get("dir"),r.value=g,s.value=o.get("q")||"";const v=x=>{const m=x.target.value,f=new URLSearchParams({...Object.fromEntries(o),q:m});E(f)},S=x=>{const m=x.target.value,f=new URLSearchParams({...Object.fromEntries(o),sort:m});f.get("dir")||f.set("dir",m==="created"?"desc":"asc"),E(f)};return s.addEventListener("input",v),r.addEventListener("change",S),()=>{s.removeEventListener("input",v),r.removeEventListener("change",S)}},[o,E]),l.useEffect(()=>{_(30)},[o.toString()]);const k=l.useMemo(()=>{if(!c)return[];let s=c;e&&(s=s.filter(h=>w.has(h.id)));const r=(o.get("q")||"").toLowerCase().trim();r&&(s=s.filter(h=>h.title&&h.title.toLowerCase().includes(r)||h.selftext_preview&&h.selftext_preview.toLowerCase().includes(r)));const g=h=>(o.get(h)||"").split(",").map(u=>u&&decodeURIComponent(u)).filter(Boolean),v=new Set(g("subs")),S=new Set(g("authors")),x=new Set(g("flairs")),m=new Set(g("media")),f=new Set(g("domains"));if(v.size||S.size||x.size||m.size||f.size){const h=(o.get("mode")||"or").toLowerCase();s=s.filter(u=>{const y=v.size&&u.subreddit&&v.has(String(u.subreddit)),$=S.size&&u.author&&S.has(String(u.author)),F=x.size&&u.flair&&x.has(String(u.flair)),U=m.size&&u.media_type&&m.has(String(u.media_type)),q=f.size&&u.link_domain&&f.has(String(u.link_domain)),D=!!(y||$||F||U||q),M=[v.size?y:!0,S.size?$:!0,x.size?F:!0,m.size?U:!0,f.size?q:!0].every(Boolean);return h==="and"?M:D})}const P=o.get("sort")||"saved",O=o.get("dir")||(P==="created"?"desc":"asc");let I=[...s].sort(W(P,O));if(o.get("favfirst")==="1"){const h=I.filter(y=>w.has(y.id)),u=I.filter(y=>!w.has(y.id));I=[...h,...u]}return I},[c,o,e,w]),d=l.useRef(null),p=l.useRef(null),C=l.useCallback(s=>{if(p.current&&d.current)try{d.current.unobserve(p.current)}catch{}if(p.current=s,s&&d.current)try{d.current.observe(s)}catch{}},[]);if(l.useEffect(()=>{if(!(typeof window>"u")){if(d.current=new IntersectionObserver(s=>{s.some(r=>r.isIntersecting)&&_(r=>r+30)},{root:null,rootMargin:"600px 0px 600px 0px",threshold:.01}),p.current)try{d.current.observe(p.current)}catch{}return()=>{try{d.current&&d.current.disconnect()}catch{}d.current=null}}},[]),n)return t.jsx("div",{className:"container",children:t.jsxs("div",{className:"card",children:[t.jsx("h3",{children:"Couldn’t load posts"}),t.jsx("div",{className:"meta",children:n})]})});if(!c)return t.jsx("div",{className:"container","aria-busy":"true",children:Array.from({length:6}).map((s,r)=>t.jsx(T,{},r))});const L=k.slice(0,N),R=N<k.length;return t.jsxs("div",{className:"container",children:[L.length===0&&t.jsxs("div",{className:"card",children:[t.jsx("h3",{children:"No results"}),t.jsx("div",{className:"meta",children:"Try clearing filters or changing your search."})]}),L.map(s=>t.jsx(K,{post:s,favs:w,setFavs:b,base:B,searchTerm:(o.get("q")||"").trim()},s.id)),R&&t.jsx("div",{ref:C,className:"sentinel"})]})}export{ne as default};
