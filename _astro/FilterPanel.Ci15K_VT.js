import{j as n}from"./jsx-runtime.D_zvdyIk.js";import{r as d}from"./index.RH_Wq4ov.js";function U(s,a){const r=new Map;for(const u of s||[]){const v=a(u);if(v==null||v==="")continue;const y=String(v);r.set(y,(r.get(y)||0)+1)}return r}const L="/Saved-Reddit/",R=L.endsWith("/")?L:L+"/",b=[{key:"subs",title:"Subreddits",field:"subreddits",pick:s=>s.subreddit},{key:"authors",title:"Authors",field:"authors",pick:s=>s.author},{key:"flairs",title:"Flairs",field:"flairs",pick:s=>s.flair},{key:"media",title:"Media Types",field:"mediaTypes",pick:s=>s.media_type},{key:"domains",title:"Domains",field:"domains",pick:s=>s.link_domain}];function M(s){const a={};for(const r of b){const u=s.get(r.key)||"";a[r.key]=u?u.split(",").map(decodeURIComponent).filter(Boolean):[]}return a}function O(s){const a=new URLSearchParams(window.location.search);for(const r of b){const u=s[r.key]||[];u.length?a.set(r.key,u.map(encodeURIComponent).join(",")):a.delete(r.key)}return a}const X=(s,a)=>s==="subs"?`r/${a}`:s==="authors"?`u/${a}`:String(a);function D(){const[s,a]=d.useState(!1),[r,u]=d.useState(null),[v,y]=d.useState(null),[h,C]=d.useState(null),[g,x]=d.useState({subs:[],authors:[],flairs:[],media:[],domains:[]}),[j,N]=d.useState(""),[E,$]=d.useState(()=>Object.fromEntries(b.map(e=>[e.key,!0]))),S=d.useRef(null);d.useEffect(()=>{let e=!0;return Promise.all([fetch(`${R}data/indexes/facets.json`).then(t=>t.json()),fetch(`${R}data/indexes/posts-manifest.json`).then(t=>t.json())]).then(([t,l])=>{if(!e)return;u(t),y(l);const o={};for(const i of b)o[i.key]=U(l,i.pick);C(o)}).catch(()=>{u(null),y(null),C(null)}),()=>{e=!1}},[]),d.useEffect(()=>{const e=()=>{const m=new URLSearchParams(window.location.search);x(M(m)),a(!0),N(""),setTimeout(()=>S.current?.focus(),0)},t=()=>a(!1);window.addEventListener("filters:open",e),window.addEventListener("filters:close",t);const l=m=>{m.key==="Escape"&&a(!1)};window.addEventListener("keydown",l);let o=null,i=!1;const c=m=>{const p=m.touches?.[0];p&&p.clientX<=24&&!s&&(i=!0,o=p.clientX)},f=m=>{if(!i)return;const p=m.touches?.[0];p&&p.clientX-o>30&&(i=!1,window.dispatchEvent(new CustomEvent("filters:open")))},w=()=>{i=!1};return window.addEventListener("touchstart",c,{passive:!0}),window.addEventListener("touchmove",f,{passive:!0}),window.addEventListener("touchend",w,{passive:!0}),()=>{window.removeEventListener("filters:open",e),window.removeEventListener("filters:close",t),window.removeEventListener("keydown",l),window.removeEventListener("touchstart",c),window.removeEventListener("touchmove",f),window.removeEventListener("touchend",w)}},[s]),d.useEffect(()=>{if(!s)return;const e=S.current;if(!e)return;const t=["a[href]","button:not([disabled])","input:not([disabled])","select:not([disabled])","textarea:not([disabled])",'[tabindex]:not([tabindex="-1"])'],l=()=>Array.from(e.querySelectorAll(t.join(",")));e.hasAttribute("tabindex")||e.setAttribute("tabindex","-1"),e.focus();const o=i=>{if(i.key!=="Tab")return;const c=l();if(!c.length)return;const f=c[0],w=c[c.length-1];i.shiftKey&&document.activeElement===f?(i.preventDefault(),w.focus()):!i.shiftKey&&document.activeElement===w&&(i.preventDefault(),f.focus())};return e.addEventListener("keydown",o),()=>e.removeEventListener("keydown",o)},[s]);const k=d.useMemo(()=>{if(!r)return null;const e=j.trim().toLowerCase(),t=i=>e?i.filter(c=>String(c).toLowerCase().includes(e)):i,l=(i,c)=>i.map(f=>({value:f,count:c?.get(String(f))||0})),o=(i,c)=>c.count-i.count||String(i.value).localeCompare(String(c.value));return{subs:l(t(r.subreddits||[]),h?.subs).sort(o),authors:l(t(r.authors||[]),h?.authors).sort(o),flairs:l(t(r.flairs||[]),h?.flairs).sort(o),media:l(t(r.mediaTypes||[]),h?.media).sort(o),domains:l(t(r.domains||[]),h?.domains).sort(o)}},[r,h,j]);function T(e,t){x(l=>{const o=new Set(l[e]);return o.has(t)?o.delete(t):o.add(t),{...l,[e]:Array.from(o)}})}function F(){const e=O(g),t=new URL(window.location.href);t.search=e.toString(),history.pushState({},"",t),window.dispatchEvent(new Event("urlchange")),a(!1)}function P(){x({subs:[],authors:[],flairs:[],media:[],domains:[]})}function A(){a(!1)}return n.jsxs(n.Fragment,{children:[n.jsx("div",{className:`backdrop ${s?"open":""}`,onClick:A}),n.jsxs("aside",{className:`drawer ${s?"open":""}`,role:"dialog","aria-modal":"true","aria-label":"Filters",tabIndex:-1,ref:S,children:[n.jsxs("header",{children:[n.jsx("span",{style:{flex:1},children:"Filters"}),n.jsx("button",{className:"button",onClick:A,"aria-label":"Close",children:"✕"})]}),n.jsxs("div",{className:"content",children:[n.jsx("input",{className:"input searchbox",placeholder:"Search filters…",value:j,onChange:e=>N(e.target.value)}),!k&&n.jsx("div",{className:"meta",children:"Loading…"}),k&&b.map(e=>n.jsxs("div",{className:"group",children:[n.jsx("h4",{children:n.jsxs("button",{type:"button",className:"button",style:{padding:"4px 8px"},onClick:()=>$(t=>({...t,[e.key]:!t[e.key]})),"aria-expanded":!E[e.key],"aria-controls":`facet-${e.key}`,children:[E[e.key]?"▸":"▾"," ",e.title]})}),!E[e.key]&&n.jsxs("div",{id:`facet-${e.key}`,className:"facetlist",children:[(k[e.key]||[]).map(({value:t,count:l})=>{const o=g[e.key]?.includes(t);return n.jsxs("label",{className:"facetitem",children:[n.jsx("input",{type:"checkbox",checked:!!o,onChange:()=>T(e.key,t)}),n.jsx("span",{children:X(e.key,t)}),n.jsx("span",{className:"meta",style:{marginLeft:"auto"},children:l})]},`${e.key}:${t}`)}),(!k[e.key]||k[e.key].length===0)&&n.jsx("div",{className:"meta",children:"No matches."})]})]},e.key))]}),n.jsxs("div",{className:"actions",children:[n.jsx("button",{className:"button",onClick:P,children:"Clear all"}),n.jsx("button",{className:"button primary",onClick:F,children:"Apply"})]})]})]})}export{D as default};
