import{j as t}from"./jsx-runtime.D_zvdyIk.js";import{r as d}from"./index.RH_Wq4ov.js";import{m as B,s as G,g as K,S as W,l as J}from"./Skeleton.CRWqq5in.js";function Z(e="",m=200){if(!e)return"";const c=String(e).replace(/[*_~`>#-]+/g," ").replace(/\[(.*?)\]\((.*?)\)/g,"$1").replace(/\s+/g," ").trim();if(c.length<=m)return c;const n=c.slice(0,m),a=n.lastIndexOf(" ");return(a>60?n.slice(0,a):n).trim()+"…"}function ee(e=""){try{return new URL(e).hostname.replace(/^www\./,"")}catch{return""}}function te(e={root:null,rootMargin:"300px",threshold:.01}){const m=d.useRef(null),[c,n]=d.useState(!1);return d.useEffect(()=>{if(!m.current||typeof IntersectionObserver>"u")return;const a=new IntersectionObserver(([v])=>n(v.isIntersecting),e);return a.observe(m.current),()=>a.disconnect()},[]),[m,c]}function ne({onSwipeLeft:e,onSwipeRight:m,threshold:c=24,maxAngle:n=36}={}){const a=d.useRef(null),v=d.useRef(null),[P,$]=d.useState(0),[_,g]=d.useState(!1),z=f=>{if(!(f.button!==void 0&&f.button!==0)){v.current={x:f.clientX,y:f.clientY,id:f.pointerId},g(!0);try{f.currentTarget.setPointerCapture?.(f.pointerId)}catch{}}},U=f=>{if(!v.current)return;const N=f.clientX-v.current.x;f.clientY-v.current.y,$(N*.95)},F=f=>{if(!v.current)return;const N=f.clientX-v.current.x,D=f.clientY-v.current.y,x=Math.abs(N),V=Math.abs(D);Math.atan2(V,x)*180/Math.PI<=n&&x>=c&&(N<0?e?.():m?.()),g(!1),$(0),v.current=null};return{bind:{ref:a,onPointerDown:z,onPointerMove:U,onPointerUp:F,onPointerCancel:F,style:{touchAction:"pan-y",transform:`translate3d(${P}px,0,0)`,transition:_?"none":"transform 160ms ease",willChange:"transform"}}}}function re({post:e,favs:m,setFavs:c,base:n,searchTerm:a="",isViewed:v=!1}){const P=s=>!s||/^https?:\/\//i.test(s)||s.startsWith(n)?s:s.startsWith("/")?n+s.slice(1):n+s,$=s=>{if(s)return s.split(",").map(y=>{const[l,S]=y.trim().split(/\s+/,2),i=P(l);return S?`${i} ${S}`:i}).join(", ")},_=m.has(e.id),g=()=>{const s=new Set(m);_?s.delete(e.id):s.add(e.id),c(s),G(s);try{typeof onFav=="function"&&onFav(e.id,!_)}catch{}},z=e.created_utc?new Date(e.created_utc*1e3):null,U=z?z.toISOString():"",F=z?z.toLocaleDateString(void 0,{month:"short",day:"numeric",year:"numeric"}):"",f=Array.isArray(e.media_items)?e.media_items:null,D=(Array.isArray(e.media_urls)?e.media_urls:e.media_url_compact?Array.isArray(e.media_url_compact)?e.media_url_compact:[e.media_url_compact]:[]).map((s,y)=>{const l=/\.mp4(\?|#|$)/i.test(s),S=/\.gif(\?|#|$)/i.test(s),i=l?"video":S?"gif":"image";return{index:y+1,kind:i,url:s}}),x=f&&f.length?f:D,V=x.length>1,r=x[0]||null,h=V?`gallery (${x.length})`:r?.kind||e.media_type||null,b=e.media_preview||e.preview?.src||null;function A(s,y){const l=(y||"").trim();if(!l)return s;try{const S=new RegExp(`(${l.replace(/[.*?^${}()|[\\]\\\\]/g,"\\$&")})`,"ig");return String(s).split(S).map((o,w)=>S.test(o)?t.jsx("mark",{children:o},w):t.jsx("span",{children:o},w))}catch{return s}}const R=Z(e.selftext_preview||(e.media_type==="link"&&e.url?`Link: ${ee(e.url)}`:"")||"",240),L=!!b||r&&(r.kind==="video"||r.kind==="redgiphy"||r.kind==="gif"),k=`pc-grid ${L?"has-thumb":"no-thumb"}`,[E,q]=d.useState(!1),C=d.useMemo(()=>{if(!E||!x.length)return null;function s({src:l,k:S}){const[i,o]=te({root:null,rootMargin:"300px",threshold:.01}),w=d.useRef(null);return d.useEffect(()=>{const u=w.current;if(u)if(o)u.play().catch(()=>{});else{u.pause();try{u.currentTime=0}catch{}}},[o]),d.useEffect(()=>()=>{try{w.current&&w.current.pause()}catch{}},[]),t.jsx("div",{ref:i,className:"pc-expand",children:t.jsx("video",{ref:w,className:"pc-media-el",src:l,autoPlay:!0,loop:!0,playsInline:!0,controls:!0,preload:"auto"},S)})}if(x.length===1){const l=x[0];return l.kind==="video"||l.kind==="redgiphy"?t.jsx(s,{src:l.url},`v:${e.id}:single`):t.jsx("div",{className:"pc-expand",children:t.jsx("img",{src:l.url,alt:"",loading:"eager",decoding:"async",className:"pc-media-el"})})}function y(){const[l,S]=d.useState(0),i=x.length,o=x[l],w=j=>S(I=>(I+j+i)%i),u=()=>w(-1),p=()=>w(1);d.useEffect(()=>{const j=I=>{I.key==="ArrowLeft"?(I.preventDefault(),u()):I.key==="ArrowRight"&&(I.preventDefault(),p())};return window.addEventListener("keydown",j),()=>window.removeEventListener("keydown",j)},[i]),d.useEffect(()=>{const j=x[(l+1)%i];if(j&&j.kind==="image"){const I=new Image;I.src=j.url}},[l,i]);const M=ne({onSwipeLeft:p,onSwipeRight:u,threshold:24,maxAngle:36});return t.jsx("div",{className:"pc-expand",children:t.jsxs("div",{className:"pc-gallery",children:[t.jsxs("div",{className:"pc-gctl",children:[t.jsx("button",{type:"button",className:"button",onClick:u,"aria-label":"Previous (←)",children:"‹ Prev"}),t.jsxs("span",{className:"pc-gcount",children:[l+1," / ",i]}),t.jsx("button",{type:"button",className:"button",onClick:p,"aria-label":"Next (→)",children:"Next ›"})]}),t.jsx("div",{className:"pc-swipe",...M.bind,children:o.kind==="video"||o.kind==="redgiphy"?t.jsx(s,{src:o.url},`v:${e.id}:${l}`):t.jsx("img",{src:o.url,alt:"",loading:"eager",decoding:"async",className:"pc-media-el",draggable:!1,onDragStart:j=>j.preventDefault()},`${o.kind[0]}:${e.id}:${l}`)})]})})}return t.jsx(y,{})},[E,x,e.id]);return t.jsx("article",{className:`card post-card ${v?"is-viewed":""}`,children:t.jsxs("div",{className:k,children:[L?t.jsx("aside",{className:"pc-left",children:t.jsx("a",{href:`${n}post/${encodeURIComponent(e.id)}`,onClick:()=>{try{const s="feed:scroll:"+location.search;sessionStorage.setItem(s,String(window.scrollY||0))}catch{}B(e.id)},children:b?t.jsx("img",{className:"pc-thumb",alt:"",loading:"lazy",decoding:"async",fetchPriority:"low",src:P(e.preview?.src||b),...e.preview?.srcset?{srcSet:$(e.preview.srcset)}:{},...e.preview?.sizes?{sizes:e.preview.sizes}:{},...e.preview?.w&&e.preview?.h?{width:e.preview.w,height:e.preview.h}:{}}):t.jsx("div",{className:"pc-thumb pc-thumb--video",children:t.jsx("span",{className:"pc-play",children:"▶"})})})}):null,t.jsxs("div",{className:"pc-right",children:[t.jsxs("div",{className:"topline",children:[e.subreddit&&t.jsxs("a",{className:"subreddit",href:`https://www.reddit.com/r/${encodeURIComponent(e.subreddit)}`,target:"_blank",rel:"noreferrer noopener",children:["r/",e.subreddit]}),t.jsx("span",{className:"dot",children:"•"}),e.author&&t.jsxs("span",{className:"by",children:["Posted by"," ",t.jsxs("a",{className:"author",href:`https://www.reddit.com/user/${encodeURIComponent(e.author)}`,target:"_blank",rel:"noreferrer noopener",children:["u/",e.author]})]}),F&&t.jsxs(t.Fragment,{children:[t.jsx("span",{className:"dot",children:"•"}),t.jsx("time",{dateTime:U,title:z?.toLocaleString?.()||"",children:F})]}),e.saved_index!=null&&t.jsxs(t.Fragment,{children:[t.jsx("span",{className:"dot",children:"•"}),t.jsxs("span",{className:"saved meta",children:["Saved #",e.saved_index]})]})]}),t.jsxs("h3",{className:"title",children:[t.jsx("a",{className:"title-link",href:`${n}post/${encodeURIComponent(e.id)}`,onClick:()=>{try{const s="feed:scroll:"+location.search;sessionStorage.setItem(s,String(window.scrollY||0))}catch{}B(e.id)},children:A(e.title,a)}),e.flair?t.jsx("span",{className:"flair",children:e.flair}):null,h?t.jsx("span",{className:"pill",children:h}):null]}),R&&t.jsx("p",{className:"preview",children:A(R,a)}),t.jsxs("div",{className:"bottomline",children:[e.score!=null&&t.jsxs("span",{className:"score",children:["▲ ",e.score]}),t.jsx("span",{className:"dot",children:"•"}),e.num_comments!=null&&t.jsxs("span",{className:"comments",children:["💬 ",e.num_comments]}),x.length>0&&t.jsxs(t.Fragment,{children:[t.jsx("span",{className:"dot",children:"•"}),t.jsx("button",{className:"action expand",type:"button",onClick:()=>{q(s=>{const y=!s;try{typeof onToggle=="function"&&onToggle(e.id,y)}catch{}return y}),B(e.id)},"aria-expanded":E?"true":"false",title:E?"Collapse media":"Expand media",children:E?"ᐱ Collapse":"⤢ Expand"})]}),t.jsx("span",{className:"spacer"}),e.permalink&&t.jsx("a",{className:"action view",href:e.permalink,target:"_blank",rel:"noopener noreferrer",onClick:()=>B(e.id),children:"View on Reddit"}),t.jsx("button",{className:`star ${_?"is-on":""}`,"aria-label":_?"Remove from favorites":"Add to favorites","aria-pressed":_?"true":"false",onClick:g,children:_?"⭐ Star":"☆ Star"})]}),C]})]})})}const se=(e,m)=>{const c=e.post??{},n=m.post??{};if(c.id!==n.id)return!1;const a=!!e.favs?.has?.(c.id),v=!!m.favs?.has?.(n.id);if(a!==v||e.searchTerm!==m.searchTerm||e.isViewed!==m.isViewed||c.score!==n.score||c.num_comments!==n.num_comments||c.flair!==n.flair||c.media_preview!==n.media_preview||c.created_utc!==n.created_utc)return!1;const P=Array.isArray(c.media_items)?c.media_items.length:0,$=Array.isArray(n.media_items)?n.media_items.length:0;return P===$},ie=d.memo(re,se),T=1e15;function O(e,m){const c=e.saved_index??T,n=m.saved_index??T;return c!==n?c-n:(m.created_utc??0)-(e.created_utc??0)}function ae(e,m="asc"){const c=m==="desc"?-1:1;switch(e){case"saved":return(n,a)=>c*O(a,n);case"created":return(n,a)=>c*((n.created_utc??0)-(a.created_utc??0));case"score":return(n,a)=>c*((n.score??-T)-(a.score??-T));case"comments":return(n,a)=>c*((n.num_comments??-T)-(a.num_comments??-T));case"title":return(n,a)=>c*String(n.title).localeCompare(String(a.title));case"subreddit":return(n,a)=>c*String(n.subreddit).localeCompare(String(a.subreddit));case"author":return(n,a)=>c*String(n.author).localeCompare(String(a.author));case"domain":return(n,a)=>c*String(n.link_domain||"").localeCompare(String(a.link_domain||""));case"flair":return(n,a)=>c*String(n.flair||"").localeCompare(String(a.flair||""));default:return(n,a)=>c*O(n,a)}}const X="/Saved-Reddit/";function ce(){return typeof window>"u"?"":window.location.search||""}function oe(){const[e,m]=d.useState(()=>new URLSearchParams(ce()));d.useEffect(()=>{if(typeof window>"u")return;const n=()=>m(new URLSearchParams(window.location.search));return window.addEventListener("popstate",n),window.addEventListener("urlchange",n),()=>{window.removeEventListener("popstate",n),window.removeEventListener("urlchange",n)}},[]);const c=d.useCallback(n=>{if(typeof window>"u")return;const a=new URL(window.location.href);a.search=n.toString(),window.history.pushState({},"",a),window.dispatchEvent(new Event("urlchange")),m(new URLSearchParams(a.search))},[]);return[e,c]}function me({favoritesOnly:e=!1}){const[m,c]=d.useState(null),[n,a]=d.useState(null),[v,P]=d.useState(new Set),[$,_]=d.useState(30),[g,z]=oe(),U=d.useMemo(()=>K({ttlDays:14}),[g.toString()]);d.useEffect(()=>{const r=()=>P(J());if(r(),typeof window<"u")return window.addEventListener("favorites:changed",r),()=>window.removeEventListener("favorites:changed",r)},[]),d.useEffect(()=>{let r=!0;return a(null),fetch(`${X}data/indexes/posts-manifest.json`).then(h=>{if(!h.ok)throw new Error(`HTTP ${h.status}`);return h.json()}).then(h=>{r&&c(h)}).catch(h=>{r&&a(h.message||"Failed to load")}),()=>{r=!1}},[]),d.useEffect(()=>{if(typeof document>"u")return;const r=document.getElementById("searchInput"),h=document.getElementById("sortSelect");if(!r||!h)return;const b=g.get("sort")||"saved";g.get("dir"),h.value=b,r.value=g.get("q")||"";const A=u=>{const p=new URL(window.location.href);p.search=u.toString(),history.replaceState({},"",p),window.dispatchEvent(new Event("urlchange"))},R=u=>{const p=new URL(window.location.href);p.search=u.toString(),history.pushState({},"",p),window.dispatchEvent(new Event("urlchange"))};let L=!1,k=null;const E=200,q=u=>{clearTimeout(k),k=setTimeout(()=>{const p=new URLSearchParams({...Object.fromEntries(g),q:u});A(p)},E)},C=u=>{clearTimeout(k);const p=new URLSearchParams({...Object.fromEntries(g),q:u});R(p)},s=u=>{L||q(u.target.value)},y=()=>{L=!0},l=u=>{L=!1,C(u.target.value)},S=u=>{u.key==="Enter"&&(u.preventDefault(),C(r.value))},i=()=>C(r.value),o=u=>C(u.target.value),w=u=>{const p=u.target.value,M=new URLSearchParams({...Object.fromEntries(g),sort:p});M.get("dir")||M.set("dir",p==="created"?"desc":"asc"),R(M)};return r.addEventListener("input",s),r.addEventListener("compositionstart",y),r.addEventListener("compositionend",l),r.addEventListener("keydown",S),r.addEventListener("blur",i),r.addEventListener("search",o),h.addEventListener("change",w),()=>{clearTimeout(k),r.removeEventListener("input",s),r.removeEventListener("compositionstart",y),r.removeEventListener("compositionend",l),r.removeEventListener("keydown",S),r.removeEventListener("blur",i),r.removeEventListener("search",o),h.removeEventListener("change",w)}},[g]),d.useEffect(()=>{_(30)},[g.toString()]);const F=d.useMemo(()=>{if(!m)return[];let r=m;e&&(r=r.filter(i=>v.has(i.id)));const h=(g.get("q")||"").toLowerCase().trim();h&&(r=r.filter(i=>i.title&&i.title.toLowerCase().includes(h)||i.selftext_preview&&i.selftext_preview.toLowerCase().includes(h)));const b=i=>(g.get(i)||"").split(",").map(o=>o&&decodeURIComponent(o)).filter(Boolean),A=new Set(b("subs")),R=new Set(b("authors")),L=new Set(b("flairs")),k=new Set(b("media")),E=new Set(b("domains"));if(A.size||R.size||L.size||k.size||E.size){const i=(g.get("mode")||"or").toLowerCase();r=r.filter(o=>{const w=A.size&&o.subreddit&&A.has(String(o.subreddit)),u=R.size&&o.author&&R.has(String(o.author)),p=L.size&&o.flair&&L.has(String(o.flair)),M=Array.isArray(o.media_types)?o.media_types:o.media_type?[o.media_type]:[],j=k.size&&M.some(Q=>k.has(String(Q))),I=E.size&&o.link_domain&&E.has(String(o.link_domain)),Y=!!(w||u||p||j||I),H=[A.size?w:!0,R.size?u:!0,L.size?p:!0,k.size?j:!0,E.size?I:!0].every(Boolean);return i==="and"?H:Y})}let C=(g.get("view")||"").toLowerCase();!C&&(g.get("hide_viewed")||"")==="1"&&(C="unviewed"),C==="unviewed"?r=r.filter(i=>!U.has(i.id)):C==="viewed"&&(r=r.filter(i=>U.has(i.id)));const s=g.get("sort")||"saved",y=g.get("dir")||(s==="created"?"desc":"asc");let l=[...r].sort(ae(s,y));if(g.get("favfirst")==="1"){const i=l.filter(w=>v.has(w.id)),o=l.filter(w=>!v.has(w.id));l=[...i,...o]}if(g.get("random")==="1"){l=[...l];for(let i=l.length-1;i>0;i--){const o=Math.floor(Math.random()*(i+1));[l[i],l[o]]=[l[o],l[i]]}}return l},[m,g,e,v,U]),f=d.useRef(null),N=d.useRef(null),D=d.useCallback(r=>{if(N.current&&f.current)try{f.current.unobserve(N.current)}catch{}if(N.current=r,r&&f.current)try{f.current.observe(r)}catch{}},[]);if(d.useEffect(()=>{if(!(typeof window>"u")){if(f.current=new IntersectionObserver(r=>{r.some(h=>h.isIntersecting)&&_(h=>h+30)},{root:null,rootMargin:"600px 0px 600px 0px",threshold:.01}),N.current)try{f.current.observe(N.current)}catch{}return()=>{try{f.current&&f.current.disconnect()}catch{}f.current=null}}},[]),n)return t.jsx("div",{className:"container",children:t.jsxs("div",{className:"card",children:[t.jsx("h3",{children:"Couldn’t load posts"}),t.jsx("div",{className:"meta",children:n})]})});if(!m)return t.jsx("div",{className:"container","aria-busy":"true",children:Array.from({length:6}).map((r,h)=>t.jsx(W,{},h))});const x=F.slice(0,$),V=$<F.length;return t.jsxs("div",{className:"container",children:[x.length===0&&t.jsxs("div",{className:"card",children:[t.jsx("h3",{children:"No results"}),t.jsx("div",{className:"meta",children:"Try clearing filters or changing your search."})]}),x.map(r=>t.jsx(ie,{post:r,favs:v,setFavs:P,base:X,searchTerm:(g.get("q")||"").trim(),isViewed:U.has(r.id)},r.id)),V&&t.jsx("div",{ref:D,className:"sentinel"})]})}export{me as default};
