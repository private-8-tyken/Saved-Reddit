import{j as o}from"./jsx-runtime.D_zvdyIk.js";import{r as d}from"./index.RH_Wq4ov.js";const L="/Saved-Reddit/",F=L.endsWith("/")?L:L+"/",k=[{key:"subs",title:"Subreddits",field:"subreddits",pick:n=>n.subreddit},{key:"authors",title:"Authors",field:"authors",pick:n=>n.author},{key:"flairs",title:"Flairs",field:"flairs",pick:n=>n.flair},{key:"media",title:"Media Types",field:"mediaTypes",pick:n=>n.media_type},{key:"domains",title:"Domains",field:"domains",pick:n=>n.link_domain}];function P(n){const a={};for(const c of k){const p=n.get(c.key)||"";a[c.key]=p?p.split(",").map(decodeURIComponent).filter(Boolean):[]}return a.mode=(n.get("mode")||"or").toLowerCase()==="and"?"and":"or",a}function X(n){const a=new URLSearchParams(window.location.search);for(const c of k){const p=n[c.key]||[];p.length?a.set(c.key,p.map(encodeURIComponent).join(",")):a.delete(c.key)}return(n.mode||"or")==="and"?a.set("mode","and"):a.delete("mode"),a}const U=(n,a)=>n==="subs"?`r/${a}`:n==="authors"?`u/${a}`:String(a);function Y(){const[n,a]=d.useState(!1),[c,p]=d.useState(null),[D,N]=d.useState(null),[g,A]=d.useState(null),[v,w]=d.useState({subs:[],authors:[],flairs:[],media:[],domains:[],mode:"or"}),[b,j]=d.useState(""),[x,T]=d.useState(()=>Object.fromEntries(k.map(e=>[e.key,!0]))),E=d.useRef(null);d.useEffect(()=>{let e=!0;return fetch(`${F}data/indexes/facets.json`).then(t=>t.json()).then(t=>{e&&p(t)}).catch(()=>{p(nul1l),N(null),A(null)}),()=>{e=!1}},[]),d.useEffect(()=>{const e=()=>{const l=new URLSearchParams(window.location.search);w(P(l)),a(!0),j(""),setTimeout(()=>E.current?.focus(),0)},t=()=>a(!1);window.addEventListener("filters:open",e),window.addEventListener("filters:close",t);const i=l=>{l.key==="Escape"&&a(!1)};window.addEventListener("keydown",i);let s=null,r=!1;const u=l=>{const h=l.touches?.[0];h&&h.clientX<=24&&!n&&(r=!0,s=h.clientX)},m=l=>{if(!r)return;const h=l.touches?.[0];h&&h.clientX-s>30&&(r=!1,window.dispatchEvent(new CustomEvent("filters:open")))},f=()=>{r=!1};return window.addEventListener("touchstart",u,{passive:!0}),window.addEventListener("touchmove",m,{passive:!0}),window.addEventListener("touchend",f,{passive:!0}),()=>{window.removeEventListener("filters:open",e),window.removeEventListener("filters:close",t),window.removeEventListener("keydown",i),window.removeEventListener("touchstart",u),window.removeEventListener("touchmove",m),window.removeEventListener("touchend",f)}},[n]),d.useEffect(()=>{if(!n)return;const e=E.current;if(!e)return;const t=["a[href]","button:not([disabled])","input:not([disabled])","select:not([disabled])","textarea:not([disabled])",'[tabindex]:not([tabindex="-1"])'],i=()=>Array.from(e.querySelectorAll(t.join(",")));e.hasAttribute("tabindex")||e.setAttribute("tabindex","-1"),e.focus();const s=r=>{if(r.key!=="Tab")return;const u=i();if(!u.length)return;const m=u[0],f=u[u.length-1];r.shiftKey&&document.activeElement===m?(r.preventDefault(),f.focus()):!r.shiftKey&&document.activeElement===f&&(r.preventDefault(),m.focus())};return e.addEventListener("keydown",s),()=>e.removeEventListener("keydown",s)},[n]),d.useEffect(()=>{if(!n||typeof window>"u"||!window.visualViewport)return;const e=window.visualViewport,t=()=>{const i=Math.max(0,window.innerHeight-e.height-e.offsetTop);document.documentElement.style.setProperty("--kb-safe",i+"px")};return e.addEventListener("resize",t),e.addEventListener("scroll",t),t(),()=>{e.removeEventListener("resize",t),e.removeEventListener("scroll",t),document.documentElement.style.removeProperty("--kb-safe")}},[n]),d.useEffect(()=>{if(!n)return;const e=E.current;if(!e)return;let t=0,i=0,s=!1;const r=f=>{const l=f.touches&&f.touches[0];l&&(t=l.clientX,i=l.clientY,s=!0)},u=f=>{if(!s)return;const l=f.touches&&f.touches[0];if(!l)return;const h=l.clientX-t,$=l.clientY-i;Math.abs(h)>30&&Math.abs(h)>Math.abs($)&&h<-30&&(f.preventDefault(),a(!1),s=!1)},m=()=>{s=!1};return e.addEventListener("touchstart",r,{passive:!0}),e.addEventListener("touchmove",u,{passive:!1}),e.addEventListener("touchend",m,{passive:!0}),e.addEventListener("touchcancel",m,{passive:!0}),()=>{e.removeEventListener("touchstart",r),e.removeEventListener("touchmove",u),e.removeEventListener("touchend",m),e.removeEventListener("touchcancel",m)}},[n]);const y=d.useMemo(()=>{if(!c)return null;b.trim().toLowerCase();const e=(s={})=>Object.keys(s).map(r=>({value:r,count:s[r]||0})),t=(s,r)=>r.count-s.count||String(s.value).localeCompare(String(r.value)),i=s=>{const r=b.trim().toLowerCase(),u=Object.keys(s||{});return r?u.filter(m=>m.toLowerCase().includes(r)):u};return{subs:e(Object.fromEntries(i(c.subreddits).map(s=>[s,c.subreddits[s]]))).sort(t),authors:e(Object.fromEntries(i(c.authors).map(s=>[s,c.authors[s]]))).sort(t),flairs:e(Object.fromEntries(i(c.flairs).map(s=>[s,c.flairs[s]]))).sort(t),media:e(Object.fromEntries(i(c.mediaTypes).map(s=>[s,c.mediaTypes[s]]))).sort(t),domains:e(Object.fromEntries(i(c.domains).map(s=>[s,c.domains[s]]))).sort(t)}},[c,g,b]);function O(e,t){w(i=>{const s=new Set(i[e]);return s.has(t)?s.delete(t):s.add(t),{...i,[e]:Array.from(s)}})}function C(e){w(t=>({...t,mode:e==="and"?"and":"or"}))}function R(){const e=X(v),t=new URL(window.location.href);t.search=e.toString(),history.pushState({},"",t),window.dispatchEvent(new Event("urlchange")),a(!1)}function M(){w({subs:[],authors:[],flairs:[],media:[],domains:[]})}function S(){a(!1)}return o.jsxs(o.Fragment,{children:[o.jsx("div",{className:`backdrop ${n?"open":""}`,onClick:S}),o.jsxs("aside",{className:`drawer ${n?"open":""}`,role:"dialog","aria-modal":"true","aria-label":"Filters",tabIndex:-1,ref:E,children:[o.jsxs("header",{children:[o.jsx("span",{style:{flex:1},children:"Filters"}),o.jsx("button",{className:"button",onClick:S,"aria-label":"Close",children:"✕"})]}),o.jsxs("div",{className:"content",children:[o.jsxs("div",{className:"row",style:{marginBottom:10},children:[o.jsx("span",{className:"meta",children:"Combine groups with"}),o.jsxs("div",{className:"row",role:"group","aria-label":"Filter mode",children:[o.jsx("button",{type:"button",className:`button ${v.mode!=="and"?"primary":""}`,"aria-pressed":v.mode!=="and",onClick:()=>C("or"),title:"Match ANY selected groups",children:"OR"}),o.jsx("button",{type:"button",className:`button ${v.mode==="and"?"primary":""}`,"aria-pressed":v.mode==="and",onClick:()=>C("and"),title:"Require ALL selected groups",children:"AND"})]})]}),o.jsx("input",{className:"input searchbox",placeholder:"Search filters…",value:b,onChange:e=>j(e.target.value)}),!y&&o.jsx("div",{className:"meta",children:"Loading…"}),y&&k.map(e=>o.jsxs("div",{className:"group",children:[o.jsx("h4",{children:o.jsxs("button",{type:"button",className:"button",style:{padding:"4px 8px"},onClick:()=>T(t=>({...t,[e.key]:!t[e.key]})),"aria-expanded":!x[e.key],"aria-controls":`facet-${e.key}`,children:[x[e.key]?"▸":"▾"," ",e.title]})}),!x[e.key]&&o.jsxs("div",{id:`facet-${e.key}`,className:"facetlist",children:[(y[e.key]||[]).map(({value:t,count:i})=>{const s=v[e.key]?.includes(t);return o.jsxs("label",{className:"facetitem",children:[o.jsx("input",{type:"checkbox",checked:!!s,onChange:()=>O(e.key,t)}),o.jsx("span",{children:U(e.key,t)}),o.jsx("span",{className:"meta",style:{marginLeft:"auto"},children:i})]},`${e.key}:${t}`)}),(!y[e.key]||y[e.key].length===0)&&o.jsx("div",{className:"meta",children:"No matches."})]})]},e.key))]}),o.jsxs("div",{className:"actions",children:[o.jsx("button",{className:"button",onClick:M,children:"Clear all"}),o.jsx("button",{className:"button primary",onClick:R,children:"Apply"})]})]})]})}export{Y as default};
