import{j as t}from"./jsx-runtime.D_zvdyIk.js";import{r as l}from"./index.RH_Wq4ov.js";import{m as B,s as G,g as K,S as W,l as J}from"./Skeleton.CRWqq5in.js";function Z(e="",u=200){if(!e)return"";const a=String(e).replace(/[*_~`>#-]+/g," ").replace(/\[(.*?)\]\((.*?)\)/g,"$1").replace(/\s+/g," ").trim();if(a.length<=u)return a;const n=a.slice(0,u),i=n.lastIndexOf(" ");return(i>60?n.slice(0,i):n).trim()+"…"}function ee(e=""){try{return new URL(e).hostname.replace(/^www\./,"")}catch{return""}}function te(e={root:null,rootMargin:"300px",threshold:.01}){const u=l.useRef(null),[a,n]=l.useState(!1);return l.useEffect(()=>{if(!u.current||typeof IntersectionObserver>"u")return;const i=new IntersectionObserver(([v])=>n(v.isIntersecting),e);return i.observe(u.current),()=>i.disconnect()},[]),[u,a]}function ne({onSwipeLeft:e,onSwipeRight:u,threshold:a=24,maxAngle:n=36}={}){const i=l.useRef(null),v=l.useRef(null),[P,$]=l.useState(0),[_,g]=l.useState(!1),z=f=>{if(!(f.button!==void 0&&f.button!==0)){v.current={x:f.clientX,y:f.clientY,id:f.pointerId},g(!0);try{f.currentTarget.setPointerCapture?.(f.pointerId)}catch{}}},U=f=>{if(!v.current)return;const N=f.clientX-v.current.x;f.clientY-v.current.y,$(N*.95)},F=f=>{if(!v.current)return;const N=f.clientX-v.current.x,D=f.clientY-v.current.y,x=Math.abs(N),V=Math.abs(D);Math.atan2(V,x)*180/Math.PI<=n&&x>=a&&(N<0?e?.():u?.()),g(!1),$(0),v.current=null};return{bind:{ref:i,onPointerDown:z,onPointerMove:U,onPointerUp:F,onPointerCancel:F,style:{touchAction:"pan-y",transform:`translate3d(${P}px,0,0)`,transition:_?"none":"transform 160ms ease",willChange:"transform"}}}}function re({post:e,favs:u,setFavs:a,base:n,searchTerm:i="",isViewed:v=!1}){const P=s=>!s||/^https?:\/\//i.test(s)||s.startsWith(n)?s:s.startsWith("/")?n+s.slice(1):n+s,$=s=>{if(s)return s.split(",").map(y=>{const[m,S]=y.trim().split(/\s+/,2),c=P(m);return S?`${c} ${S}`:c}).join(", ")},_=u.has(e.id),g=()=>{const s=new Set(u);_?s.delete(e.id):s.add(e.id),a(s),G(s);try{typeof onFav=="function"&&onFav(e.id,!_)}catch{}},z=e.created_utc?new Date(e.created_utc*1e3):null,U=z?z.toISOString():"",F=z?z.toLocaleDateString(void 0,{month:"short",day:"numeric",year:"numeric"}):"",f=Array.isArray(e.media_items)?e.media_items:null,D=(Array.isArray(e.media_urls)?e.media_urls:e.media_url_compact?Array.isArray(e.media_url_compact)?e.media_url_compact:[e.media_url_compact]:[]).map((s,y)=>{const m=/\.mp4(\?|#|$)/i.test(s),S=/\.gif(\?|#|$)/i.test(s),c=m?"video":S?"gif":"image";return{index:y+1,kind:c,url:s}}),x=f&&f.length?f:D,V=x.length>1,r=x[0]||null,h=V?`gallery (${x.length})`:r?.kind||e.media_type||null,b=e.media_preview||e.preview?.src||null;function A(s,y){const m=(y||"").trim();if(!m)return s;try{const S=new RegExp(`(${m.replace(/[.*?^${}()|[\\]\\\\]/g,"\\$&")})`,"ig");return String(s).split(S).map((o,w)=>S.test(o)?t.jsx("mark",{children:o},w):t.jsx("span",{children:o},w))}catch{return s}}const R=Z(e.selftext_preview||(e.media_type==="link"&&e.url?`Link: ${ee(e.url)}`:"")||"",240),L=!!b||r&&(r.kind==="video"||r.kind==="redgiphy"||r.kind==="gif"),k=`pc-grid ${L?"has-thumb":"no-thumb"}`,[E,q]=l.useState(!1),C=l.useMemo(()=>{if(!E||!x.length)return null;function s({src:m,k:S}){const[c,o]=te({root:null,rootMargin:"300px",threshold:.01}),w=l.useRef(null);return l.useEffect(()=>{const d=w.current;if(d)if(o)d.play().catch(()=>{});else{d.pause();try{d.currentTime=0}catch{}}},[o]),l.useEffect(()=>()=>{try{w.current&&w.current.pause()}catch{}},[]),t.jsx("div",{ref:c,className:"pc-expand",children:t.jsx("video",{ref:w,className:"pc-media-el",src:m,autoPlay:!0,loop:!0,playsInline:!0,controls:!0,preload:"auto"},S)})}if(x.length===1){const m=x[0];return m.kind==="video"||m.kind==="redgiphy"?t.jsx(s,{src:m.url},`v:${e.id}:single`):t.jsx("div",{className:"pc-expand",children:t.jsx("img",{src:m.url,alt:"",loading:"eager",decoding:"async",className:"pc-media-el"})})}function y(){const[m,S]=l.useState(0),c=x.length,o=x[m],w=j=>S(I=>(I+j+c)%c),d=()=>w(-1),p=()=>w(1);l.useEffect(()=>{const j=I=>{I.key==="ArrowLeft"?(I.preventDefault(),d()):I.key==="ArrowRight"&&(I.preventDefault(),p())};return window.addEventListener("keydown",j),()=>window.removeEventListener("keydown",j)},[c]),l.useEffect(()=>{const j=x[(m+1)%c];if(j&&j.kind==="image"){const I=new Image;I.src=j.url}},[m,c]);const T=ne({onSwipeLeft:p,onSwipeRight:d,threshold:24,maxAngle:36});return t.jsx("div",{className:"pc-expand",children:t.jsxs("div",{className:"pc-gallery",children:[t.jsxs("div",{className:"pc-gctl",children:[t.jsx("button",{type:"button",className:"button",onClick:d,"aria-label":"Previous (←)",children:"‹ Prev"}),t.jsxs("span",{className:"pc-gcount",children:[m+1," / ",c]}),t.jsx("button",{type:"button",className:"button",onClick:p,"aria-label":"Next (→)",children:"Next ›"})]}),t.jsx("div",{className:"pc-swipe",...T.bind,children:o.kind==="video"||o.kind==="redgiphy"?t.jsx(s,{src:o.url},`v:${e.id}:${m}`):t.jsx("img",{src:o.url,alt:"",loading:"eager",decoding:"async",className:"pc-media-el",draggable:!1,onDragStart:j=>j.preventDefault()},`${o.kind[0]}:${e.id}:${m}`)})]})})}return t.jsx(y,{})},[E,x,e.id]);return t.jsx("article",{className:`card post-card ${v?"is-viewed":""}`,children:t.jsxs("div",{className:k,children:[L?t.jsx("aside",{className:"pc-left",children:t.jsx("a",{href:`${n}post/${encodeURIComponent(e.id)}`,onClick:()=>{try{const s="feed:scroll:"+location.search;sessionStorage.setItem(s,String(window.scrollY||0))}catch{}B(e.id)},children:b?t.jsx("img",{className:"pc-thumb",alt:"",loading:"lazy",decoding:"async",fetchPriority:"low",src:P(e.preview?.src||b),...e.preview?.srcset?{srcSet:$(e.preview.srcset)}:{},...e.preview?.sizes?{sizes:e.preview.sizes}:{},...e.preview?.w&&e.preview?.h?{width:e.preview.w,height:e.preview.h}:{}}):t.jsx("div",{className:"pc-thumb pc-thumb--video",children:t.jsx("span",{className:"pc-play",children:"▶"})})})}):null,t.jsxs("div",{className:"pc-right",children:[t.jsxs("div",{className:"topline",children:[e.subreddit&&t.jsxs("a",{className:"subreddit",href:`https://www.reddit.com/r/${encodeURIComponent(e.subreddit)}`,target:"_blank",rel:"noreferrer noopener",children:["r/",e.subreddit]}),t.jsx("span",{className:"dot",children:"•"}),e.author&&t.jsxs("span",{className:"by",children:["Posted by"," ",t.jsxs("a",{className:"author",href:`https://www.reddit.com/user/${encodeURIComponent(e.author)}`,target:"_blank",rel:"noreferrer noopener",children:["u/",e.author]})]}),F&&t.jsxs(t.Fragment,{children:[t.jsx("span",{className:"dot",children:"•"}),t.jsx("time",{dateTime:U,title:z?.toLocaleString?.()||"",children:F})]}),e.saved_index!=null&&t.jsxs(t.Fragment,{children:[t.jsx("span",{className:"dot",children:"•"}),t.jsxs("span",{className:"saved meta",children:["Saved #",e.saved_index]})]})]}),t.jsxs("h3",{className:"title",children:[t.jsx("a",{className:"title-link",href:`${n}post/${encodeURIComponent(e.id)}`,onClick:()=>{try{const s="feed:scroll:"+location.search;sessionStorage.setItem(s,String(window.scrollY||0))}catch{}B(e.id)},children:A(e.title,i)}),e.flair?t.jsx("span",{className:"flair",children:e.flair}):null,h?t.jsx("span",{className:"pill",children:h}):null]}),R&&t.jsx("p",{className:"preview",children:A(R,i)}),t.jsxs("div",{className:"bottomline",children:[e.score!=null&&t.jsxs("span",{className:"score",children:["▲ ",e.score]}),t.jsx("span",{className:"dot",children:"•"}),e.num_comments!=null&&t.jsxs("span",{className:"comments",children:["💬 ",e.num_comments]}),x.length>0&&t.jsxs(t.Fragment,{children:[t.jsx("span",{className:"dot",children:"•"}),t.jsx("button",{className:"action expand",type:"button",onClick:()=>{q(s=>{const y=!s;try{typeof onToggle=="function"&&onToggle(e.id,y)}catch{}return y}),B(e.id)},"aria-expanded":E?"true":"false",title:E?"Collapse media":"Expand media",children:E?"ᐱ Collapse":"⤢ Expand"})]}),t.jsx("span",{className:"spacer"}),e.permalink&&t.jsx("a",{className:"action view",href:e.permalink,target:"_blank",rel:"noopener noreferrer",onClick:()=>B(e.id),children:"View on Reddit"}),t.jsx("button",{className:`star ${_?"is-on":""}`,"aria-label":_?"Remove from favorites":"Add to favorites","aria-pressed":_?"true":"false",onClick:g,children:_?"⭐ Star":"☆ Star"})]}),C]})]})})}const se=(e,u)=>{const a=e.post??{},n=u.post??{};if(a.id!==n.id)return!1;const i=!!e.favs?.has?.(a.id),v=!!u.favs?.has?.(n.id);if(i!==v||e.searchTerm!==u.searchTerm||e.isViewed!==u.isViewed||a.score!==n.score||a.num_comments!==n.num_comments||a.flair!==n.flair||a.media_preview!==n.media_preview||a.created_utc!==n.created_utc)return!1;const P=Array.isArray(a.media_items)?a.media_items.length:0,$=Array.isArray(n.media_items)?n.media_items.length:0;return P===$},ie=l.memo(re,se),M=1e15;function O(e,u){const a=e.saved_index??M,n=u.saved_index??M;return a!==n?a-n:(u.created_utc??0)-(e.created_utc??0)}function ae(e,u="asc"){const a=u==="desc"?-1:1;switch(e){case"saved":return(n,i)=>a*O(n,i);case"created":return(n,i)=>a*((n.created_utc??0)-(i.created_utc??0));case"score":return(n,i)=>a*((n.score??-M)-(i.score??-M));case"comments":return(n,i)=>a*((n.num_comments??-M)-(i.num_comments??-M));case"title":return(n,i)=>a*String(n.title).localeCompare(String(i.title));case"subreddit":return(n,i)=>a*String(n.subreddit).localeCompare(String(i.subreddit));case"author":return(n,i)=>a*String(n.author).localeCompare(String(i.author));case"domain":return(n,i)=>a*String(n.link_domain||"").localeCompare(String(i.link_domain||""));case"flair":return(n,i)=>a*String(n.flair||"").localeCompare(String(i.flair||""));default:return(n,i)=>a*O(n,i)}}const X="/Saved-Reddit/";function ce(){return typeof window>"u"?"":window.location.search||""}function oe(){const[e,u]=l.useState(()=>new URLSearchParams(ce()));l.useEffect(()=>{if(typeof window>"u")return;const n=()=>u(new URLSearchParams(window.location.search));return window.addEventListener("popstate",n),window.addEventListener("urlchange",n),()=>{window.removeEventListener("popstate",n),window.removeEventListener("urlchange",n)}},[]);const a=l.useCallback(n=>{if(typeof window>"u")return;const i=new URL(window.location.href);i.search=n.toString(),window.history.pushState({},"",i),window.dispatchEvent(new Event("urlchange")),u(new URLSearchParams(i.search))},[]);return[e,a]}function me({favoritesOnly:e=!1}){const[u,a]=l.useState(null),[n,i]=l.useState(null),[v,P]=l.useState(new Set),[$,_]=l.useState(30),[g,z]=oe(),U=l.useMemo(()=>K({ttlDays:14}),[g.toString()]);l.useEffect(()=>{const r=()=>P(J());if(r(),typeof window<"u")return window.addEventListener("favorites:changed",r),()=>window.removeEventListener("favorites:changed",r)},[]),l.useEffect(()=>{let r=!0;return i(null),fetch(`${X}data/indexes/posts-manifest.json`).then(h=>{if(!h.ok)throw new Error(`HTTP ${h.status}`);return h.json()}).then(h=>{r&&a(h)}).catch(h=>{r&&i(h.message||"Failed to load")}),()=>{r=!1}},[]),l.useEffect(()=>{if(typeof document>"u")return;const r=document.getElementById("searchInput"),h=document.getElementById("sortSelect");if(!r||!h)return;const b=g.get("sort")||"saved";g.get("dir"),h.value=b,r.value=g.get("q")||"";const A=d=>{const p=new URL(window.location.href);p.search=d.toString(),history.replaceState({},"",p),window.dispatchEvent(new Event("urlchange"))},R=d=>{const p=new URL(window.location.href);p.search=d.toString(),history.pushState({},"",p),window.dispatchEvent(new Event("urlchange"))};let L=!1,k=null;const E=200,q=d=>{clearTimeout(k),k=setTimeout(()=>{const p=new URLSearchParams({...Object.fromEntries(g),q:d});A(p)},E)},C=d=>{clearTimeout(k);const p=new URLSearchParams({...Object.fromEntries(g),q:d});R(p)},s=d=>{L||q(d.target.value)},y=()=>{L=!0},m=d=>{L=!1,C(d.target.value)},S=d=>{d.key==="Enter"&&(d.preventDefault(),C(r.value))},c=()=>C(r.value),o=d=>C(d.target.value),w=d=>{const p=d.target.value,T=new URLSearchParams({...Object.fromEntries(g),sort:p});T.get("dir")||T.set("dir",p==="created"?"desc":"asc"),R(T)};return r.addEventListener("input",s),r.addEventListener("compositionstart",y),r.addEventListener("compositionend",m),r.addEventListener("keydown",S),r.addEventListener("blur",c),r.addEventListener("search",o),h.addEventListener("change",w),()=>{clearTimeout(k),r.removeEventListener("input",s),r.removeEventListener("compositionstart",y),r.removeEventListener("compositionend",m),r.removeEventListener("keydown",S),r.removeEventListener("blur",c),r.removeEventListener("search",o),h.removeEventListener("change",w)}},[g]),l.useEffect(()=>{_(30)},[g.toString()]);const F=l.useMemo(()=>{if(!u)return[];let r=u;e&&(r=r.filter(c=>v.has(c.id)));const h=(g.get("q")||"").toLowerCase().trim();h&&(r=r.filter(c=>c.title&&c.title.toLowerCase().includes(h)||c.selftext_preview&&c.selftext_preview.toLowerCase().includes(h)));const b=c=>(g.get(c)||"").split(",").map(o=>o&&decodeURIComponent(o)).filter(Boolean),A=new Set(b("subs")),R=new Set(b("authors")),L=new Set(b("flairs")),k=new Set(b("media")),E=new Set(b("domains"));if(A.size||R.size||L.size||k.size||E.size){const c=(g.get("mode")||"or").toLowerCase();r=r.filter(o=>{const w=A.size&&o.subreddit&&A.has(String(o.subreddit)),d=R.size&&o.author&&R.has(String(o.author)),p=L.size&&o.flair&&L.has(String(o.flair)),T=Array.isArray(o.media_types)?o.media_types:o.media_type?[o.media_type]:[],j=k.size&&T.some(Q=>k.has(String(Q))),I=E.size&&o.link_domain&&E.has(String(o.link_domain)),Y=!!(w||d||p||j||I),H=[A.size?w:!0,R.size?d:!0,L.size?p:!0,k.size?j:!0,E.size?I:!0].every(Boolean);return c==="and"?H:Y})}let C=(g.get("view")||"").toLowerCase();!C&&(g.get("hide_viewed")||"")==="1"&&(C="unviewed"),C==="unviewed"?r=r.filter(c=>!U.has(c.id)):C==="viewed"&&(r=r.filter(c=>U.has(c.id)));const s=g.get("sort")||"saved",y=g.get("dir")||(s==="created"?"desc":"asc");let m=[...r].sort(ae(s,y));if(g.get("favfirst")==="1"){const c=m.filter(w=>v.has(w.id)),o=m.filter(w=>!v.has(w.id));m=[...c,...o]}return m},[u,g,e,v,U]),f=l.useRef(null),N=l.useRef(null),D=l.useCallback(r=>{if(N.current&&f.current)try{f.current.unobserve(N.current)}catch{}if(N.current=r,r&&f.current)try{f.current.observe(r)}catch{}},[]);if(l.useEffect(()=>{if(!(typeof window>"u")){if(f.current=new IntersectionObserver(r=>{r.some(h=>h.isIntersecting)&&_(h=>h+30)},{root:null,rootMargin:"600px 0px 600px 0px",threshold:.01}),N.current)try{f.current.observe(N.current)}catch{}return()=>{try{f.current&&f.current.disconnect()}catch{}f.current=null}}},[]),n)return t.jsx("div",{className:"container",children:t.jsxs("div",{className:"card",children:[t.jsx("h3",{children:"Couldn’t load posts"}),t.jsx("div",{className:"meta",children:n})]})});if(!u)return t.jsx("div",{className:"container","aria-busy":"true",children:Array.from({length:6}).map((r,h)=>t.jsx(W,{},h))});const x=F.slice(0,$),V=$<F.length;return t.jsxs("div",{className:"container",children:[x.length===0&&t.jsxs("div",{className:"card",children:[t.jsx("h3",{children:"No results"}),t.jsx("div",{className:"meta",children:"Try clearing filters or changing your search."})]}),x.map(r=>t.jsx(ie,{post:r,favs:v,setFavs:P,base:X,searchTerm:(g.get("q")||"").trim(),isViewed:U.has(r.id)},r.id)),V&&t.jsx("div",{ref:D,className:"sentinel"})]})}export{me as default};
